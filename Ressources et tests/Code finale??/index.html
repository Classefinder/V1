<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte avec Leaflet, OSRM et GeoJSON</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css" />  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>  
</head>
<body>
  <div id="map" style="height: 100vh;"></div>

  <script>
    // --- 1. Initialisation de la carte et couche de fond ---
    var map = L.map('map').setView([45.9368, 6.1322], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 2. Données GeoJSON de base pour chaque étage ---
    // Ajout de la propriété "etage" dans les salles pour faciliter la gestion
    // Étage 0 : Salle A (Polygon) et Chemin associé (LineString)
    var salleEtage0 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Salle A", "etage": 0 },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[2.35, 48.85], [2.351, 48.85], [2.351, 48.851], [2.35, 48.851], [2.35, 48.85]]]
          }
        }
      ]
    };
    var cheminEtage0 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Salle A" },
          "geometry": {
            "type": "LineString",
            "coordinates": [[2.35, 48.85], [2.352, 48.852]]
          }
        }
      ]
    };

    // Étage 1 : Salle B (Polygon) et Chemin associé (LineString)
    var salleEtage1 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Salle B", "etage": 1 },
          "geometry": {
            "type": "Polygon",
            "coordinates": [[[2.353, 48.853], [2.354, 48.853], [2.354, 48.854], [2.353, 48.854], [2.353, 48.853]]]
          }
        }
      ]
    };
    var cheminEtage1 = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": { "name": "Salle B" },
          "geometry": {
            "type": "LineString",
            "coordinates": [[2.353, 48.853], [2.355, 48.855]]
          }
        }
      ]
    };

    // --- 3. Création des couches séparées pour salles et chemins ---
    var salleLayer0 = L.geoJSON(salleEtage0, {
      style: { color: 'red', weight: 2, fillOpacity: 0.4 }
    });
    var cheminLayer0 = L.geoJSON(cheminEtage0, {
      style: { color: 'red', weight: 2, dashArray: '4' }
    });

    var salleLayer1 = L.geoJSON(salleEtage1, {
      style: { color: 'blue', weight: 2, fillOpacity: 0.4 }
    });
    var cheminLayer1 = L.geoJSON(cheminEtage1, {
      style: { color: 'blue', weight: 2, dashArray: '4' }
    });

    // --- 4. Création des couches d'itinéraire (initialement vides) ---
    var itinéraireEtage0 = {
      "type": "FeatureCollection",
      "features": []
    };
    var itinéraireEtage1 = {
      "type": "FeatureCollection",
      "features": []
    };

    var itinéraireLayer0 = L.geoJSON(itinéraireEtage0, {
      style: { color: 'purple', weight: 4 }
    });
    var itinéraireLayer1 = L.geoJSON(itinéraireEtage1, {
      style: { color: 'pink', weight: 4 }
    });

    // --- 5. Création des groupes par étage ---
    var etage0 = L.layerGroup([ salleLayer0, cheminLayer0, itinéraireLayer0 ]).addTo(map);
    var etage1 = L.layerGroup([ salleLayer1, cheminLayer1, itinéraireLayer1 ]).addTo(map);

    // --- 6. Variables pour la gestion des marqueurs (départ et fin) ---
    var startPoint = null;  // Marqueur de départ
    var endPoint = null;    // Marqueur de fin

    // --- 7. Fonction utilitaire de surlignage ---
    function highlightFeature(layer) {
      layer.setStyle({
        color: 'yellow',
        weight: 3,
        fillOpacity: 0.7
      });
      layer.bringToFront();
    }
    function resetHighlight() {
      // Réinitialise le style des salles pour les deux étages
      salleLayer0.eachLayer(function(layer) {
        salleLayer0.resetStyle(layer);
      });
      salleLayer1.eachLayer(function(layer) {
        salleLayer1.resetStyle(layer);
      });
    }

    // --- 8. Fonction de vérification et calcul de l'itinéraire ---
    function checkAndCalculateRoute() {
      if (startPoint && endPoint) {
        var startCoords = [startPoint.getLatLng().lat, startPoint.getLatLng().lng];
        var endCoords   = [endPoint.getLatLng().lat, endPoint.getLatLng().lng];
        getRouteAndPoints(startCoords, endCoords);
      }
    }

    // --- 9. Barre de recherche pour le marqueur de départ ---
    // La recherche ne porte que sur les salles
    var searchGroup = L.featureGroup([ salleLayer0, salleLayer1 ]);
    var searchControlStart = new L.Control.Search({
      layer: searchGroup,
      propertyName: 'name',  // Recherche par propriété "name"
      marker: false,         // Pas de marqueur automatique
      moveToLocation: function(latlng, title, map) {
        map.setView(latlng, 17);
      },
      position: 'topleft'
    });
    map.addControl(searchControlStart);

    // Gestion de l'événement de recherche pour le point de départ
    searchControlStart.on('search:locationfound', function(e) {
      resetHighlight();
      if (startPoint) {
        map.removeLayer(startPoint);
        startPoint = null;
      }

      var salleFeature = e.layer;
      highlightFeature(salleFeature);
      map.fitBounds(salleFeature.getBounds());

      var etage = salleFeature.feature.properties.etage;
      var cheminLayer = (etage === 0) ? cheminLayer0 : cheminLayer1;

      var cheminFeature = null;
      cheminLayer.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties.name === salleFeature.feature.properties.name) {
          cheminFeature = layer;
        }
      });
      if (cheminFeature) {
        var center = cheminFeature.getBounds().getCenter();
        startPoint = L.marker(center).addTo(map)
          .bindPopup("Point de départ sur le chemin de " + salleFeature.feature.properties.name)
          .openPopup();
      }
      // Calcul de l'itinéraire si le marqueur de fin existe déjà
      checkAndCalculateRoute();
    });

    // --- 10. Barre de recherche pour le marqueur de fin ---
    var searchControlEnd = new L.Control.Search({
      layer: searchGroup,
      propertyName: 'name',
      marker: false,
      moveToLocation: function(latlng, title, map) {
        map.setView(latlng, 17);
      },
      position: 'topright'
    });
    map.addControl(searchControlEnd);

    searchControlEnd.on('search:locationfound', function(e) {
      resetHighlight();
      if (endPoint) {
        map.removeLayer(endPoint);
        endPoint = null;
      }

      var salleFeature = e.layer;
      highlightFeature(salleFeature);
      map.fitBounds(salleFeature.getBounds());

      var etage = salleFeature.feature.properties.etage;
      var cheminLayer = (etage === 0) ? cheminLayer0 : cheminLayer1;

      var cheminFeature = null;
      cheminLayer.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties.name === salleFeature.feature.properties.name) {
          cheminFeature = layer;
        }
      });
      if (cheminFeature) {
        var center = cheminFeature.getBounds().getCenter();
        endPoint = L.marker(center).addTo(map)
          .bindPopup("Point de fin sur le chemin de " + salleFeature.feature.properties.name)
          .openPopup();
      }
      // Calcul de l'itinéraire si le marqueur de départ existe déjà
      checkAndCalculateRoute();
    });

    // --- 11. Fonction de récupération de l'itinéraire (OSRM) ---
    function getRouteAndPoints(start, end) {
      var osrmUrl = `http://89.168.57.91:5000/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?steps=true&geometries=geojson&overview=full`;

      fetch(osrmUrl)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            var route = data.routes[0];

            itinéraireLayer0.clearLayers();
            itinéraireLayer1.clearLayers();

            route.legs[0].steps.forEach((step, index) => {
              var startName = step.name || "";
              var endName = (route.legs[0].steps[index + 1] || {}).name || "";
              var segment = {
                type: "Feature",
                geometry: {
                  type: "LineString",
                  coordinates: step.geometry.coordinates
                },
                properties: {
                  name: startName
                }
              };

              if (startName.toLowerCase().includes("0") || endName.toLowerCase().includes("0")) {
                itinéraireLayer0.addData(segment);
              }
              if (startName.toLowerCase().includes("1") || endName.toLowerCase().includes("1")) {
                itinéraireLayer1.addData(segment);
              }
            });

            var bounds = L.geoJSON(route.geometry).getBounds();
            map.fitBounds(bounds);
          }
        })
        .catch(error => {
          console.error('Erreur lors de la récupération de l\'itinéraire:', error);
        });
    }

    // --- 12. Contrôle des calques pour la gestion d'étage ---
    var baseLayers = {
      "Étage 0 (Salles & Chemins)": etage0,
      "Étage 1 (Salles & Chemins)": etage1
    };
    L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);
  </script>
</body>
</html>
