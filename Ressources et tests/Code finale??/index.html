<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carte avec Leaflet, OSRM et GeoJSON</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css" />  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>  
</head>
<body>
  <div id="map" style="height: 100vh;"></div>

  <script>
    // --- 1. Initialisation de la carte et couche de fond ---
    var map = L.map('map').setView([45.9368, 6.1322], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 25,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 2. Données GeoJSON de base pour chaque étage ---
    var salleEtage0 = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "name": "13" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": null }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.13281075656434, 45.937507327903141 ], [ 6.132811540684995, 45.937512671949321 ], [ 6.132903753273905, 45.937506782592266 ], [ 6.132903145580401, 45.937501043195077 ], [ 6.13281075656434, 45.937507327903141 ] ] ] ] } }
      ]
    };
    var CheminEtage = {
      "type": "FeatureCollection",
      "features": [
        {
          "type": "Feature",
          "properties": {
            "highway": "footway",
            "foot": "yes",
            "name": "117"
          },
          "geometry": {
            "type": "LineString",
            "coordinates": [
              [ 6.13262597317, 45.93730997085 ],
              [ 6.13267764764, 45.93730437775 ]
            ]
          }
        },
        {
          "type": "Feature",
          "properties": {
            "highway": "footway",
            "foot": "yes",
            "name": "13"
          },
          "geometry": {
            "type": "LineString",
            "coordinates": [
              [ 6.13262517, 45.93730997085 ],
              [ 6.13267764764, 45.937775 ]
            ]
          }
        }
      ]
    };

    var salleEtage1 = {
      "type": "FeatureCollection",
      "features": [
        { "type": "Feature", "properties": { "name": "117" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": null }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132684614005758, 45.937194477877519 ], [ 6.132735001598985, 45.937222992336032 ], [ 6.132715571089178, 45.93723696327018 ], [ 6.132666006822637, 45.937208677850656 ], [ 6.132684614005758, 45.937194477877519 ] ] ] ] } }
      ]
    };

    // --- 3. Création des couches séparées pour les salles ---
    var salleLayer0 = L.geoJSON(salleEtage0, {
      style: { color: 'red', weight: 2, fillOpacity: 0.4 }
    });
    var salleLayer1 = L.geoJSON(salleEtage1, {
      style: { color: 'blue', weight: 2, fillOpacity: 0.4 }
    });

    // --- 4. Création du calque CheminEtage ---
    var CheminEtageLayer = L.geoJSON(CheminEtage, {
      style: { color: 'transparent' }
    });
    CheminEtageLayer.addTo(map);

    // --- 5. Création des couches d'itinéraire (initialement vides) ---
    var itinéraireEtage0 = { "type": "FeatureCollection", "features": [] };
    var itinéraireEtage1 = { "type": "FeatureCollection", "features": [] };

    var itinéraireLayer0 = L.geoJSON(itinéraireEtage0, { style: { color: 'purple', weight: 4 } });
    var itinéraireLayer1 = L.geoJSON(itinéraireEtage1, { style: { color: 'pink', weight: 4 } });

    // --- 6. Création des groupes par étage ---
    var etage0 = L.layerGroup([ salleLayer0, itinéraireLayer0 ]).addTo(map);
    var etage1 = L.layerGroup([ salleLayer1, itinéraireLayer1 ]).addTo(map);

    // --- 7. Variables pour la gestion des marqueurs (départ et fin) ---
    var startPoint = null;
    var endPoint = null;

    // --- 8. Fonctions de surlignage ---
    function highlightFeature(layer) {
      layer.setStyle({ color: 'yellow', weight: 3, fillOpacity: 0.7 });
      layer.bringToFront();
    }
    function resetHighlight() {
      salleLayer0.eachLayer(function(layer) {
        salleLayer0.resetStyle(layer);
      });
      salleLayer1.eachLayer(function(layer) {
        salleLayer1.resetStyle(layer);
      });
    }

    // --- 9. Fonction de vérification et calcul de l'itinéraire ---
    function checkAndCalculateRoute() {
      if (startPoint && endPoint) {
        var startCoords = [ startPoint.getLatLng().lat, startPoint.getLatLng().lng ];
        var endCoords   = [ endPoint.getLatLng().lat, endPoint.getLatLng().lng ];
        getRouteAndPoints(startCoords, endCoords);
      }
    }

    // --- 10. Barre de recherche pour le marqueur de départ ---
    var searchGroup = L.featureGroup([ salleLayer0, salleLayer1 ]);
    var searchControlStart = new L.Control.Search({
      layer: searchGroup,
      propertyName: 'name',
      marker: false,
      moveToLocation: function(latlng, title, map) {
        map.setView(latlng, 17);
      },
      position: 'topleft'
    });
    map.addControl(searchControlStart);

    searchControlStart.on('search:locationfound', function(e) {
      resetHighlight();
      if (startPoint) { map.removeLayer(startPoint); startPoint = null; }
      var salleFeature = e.layer;
      highlightFeature(salleFeature);
      map.fitBounds(salleFeature.getBounds());

      var cheminFeature = null;
      CheminEtageLayer.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties.name === salleFeature.feature.properties.name) {
          cheminFeature = layer;
        }
      });
      if (cheminFeature) {
        var center = cheminFeature.getBounds().getCenter();
        startPoint = L.marker(center).addTo(map)
          .bindPopup("Point de départ sur le chemin de " + salleFeature.feature.properties.name)
          .openPopup();
      }
      checkAndCalculateRoute();
    });

    // --- 11. Barre de recherche pour le marqueur de fin ---
    var searchControlEnd = new L.Control.Search({
      layer: searchGroup,
      propertyName: 'name',
      marker: false,
      moveToLocation: function(latlng, title, map) {
        map.setView(latlng, 17);
      },
      position: 'topright'
    });
    map.addControl(searchControlEnd);

    searchControlEnd.on('search:locationfound', function(e) {
      resetHighlight();
      if (endPoint) { map.removeLayer(endPoint); endPoint = null; }
      var salleFeature = e.layer;
      highlightFeature(salleFeature);
      map.fitBounds(salleFeature.getBounds());

      var cheminFeature = null;
      CheminEtageLayer.eachLayer(function(layer) {
        if (layer.feature && layer.feature.properties.name === salleFeature.feature.properties.name) {
          cheminFeature = layer;
        }
      });
      if (cheminFeature) {
        var center = cheminFeature.getBounds().getCenter();
        endPoint = L.marker(center).addTo(map)
          .bindPopup("Point de fin sur le chemin de " + salleFeature.feature.properties.name)
          .openPopup();
      }
      checkAndCalculateRoute();
    });

    // --- 12. Récupération de l'itinéraire (OSRM) ---
    function getRouteAndPoints(start, end) {
      var osrmUrl = `http://89.168.57.91:5000/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?steps=true&geometries=geojson&overview=full`;

      fetch(osrmUrl)
        .then(response => response.json())
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            var route = data.routes[0];
            itinéraireLayer0.clearLayers();
            itinéraireLayer1.clearLayers();

            // Pour chaque étape, on utilise uniquement step.name pour déterminer l'étage.
            route.legs[0].steps.forEach((step) => {
              // On s'attend à ce que step.name soit exactement "0" ou "1"
              var floor = (step.name || "").trim();
              var segment = {
                type: "Feature",
                geometry: {
                  type: "LineString",
                  coordinates: step.geometry.coordinates
                },
                properties: { name: floor }
              };

              if (floor === "0") {
                itinéraireLayer0.addData(segment);
              } else if (floor === "1") {
                itinéraireLayer1.addData(segment);
              }
              // Sinon, le segment n'est pas ajouté (ou vous pouvez décider d'une action par défaut)
            });

            var bounds = L.geoJSON(route.geometry).getBounds();
            map.fitBounds(bounds);
          }
        })
        .catch(error => {
          console.error('Erreur lors de la récupération de l\'itinéraire:', error);
        });
    }

    // --- 13. Contrôle des calques ---
    var baseLayers = {
      "Étage 0": etage0,
      "Étage 1": etage1
    };
    L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);
  </script>
</body>
</html>
