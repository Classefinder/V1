<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Classefinder | Lycée Lachenal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@maplibre/maplibre-gl-leaflet@0.0.22/leaflet-maplibre-gl.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css"/>
    <link rel="stylesheet" href="LyceeLachenal.css" />
    <script src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
      #map {
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="dark-mode-toggle"></button>

    <script>
      // --- 1. Initialisation des limites ---
      var sudOuest = L.latLng(45.93818505744445, 6.134245788738398);
      var nordEst = L.latLng(45.93640970079779, 6.13115811037474);
      var limites = L.latLngBounds(sudOuest, nordEst);

      // --- 2. Création de la carte ---
      var map = L.map("map", {
        center: [45.9368, 6.1322],
        zoom: 18,
        minZoom: 17,
        maxZoom: 23,
        maxBounds: limites,
        maxBoundsViscosity: 1.0,
      });

      // Créez uniquement une fois les deux panes, dans l'ordre souhaité :
      map.createPane("routePane");
      map.getPane("routePane").style.zIndex = 600; // Pane pour les itinéraires

      map.createPane("arrowPane");
      map.getPane("arrowPane").style.zIndex = 650; // Pane pour les flèches

      // Assurez-vous que le pane "arrowPane" est le dernier enfant dans le conteneur
      map.getPane("arrowPane").parentNode.appendChild(map.getPane("arrowPane"));

      // --- 3. Tuiles vectorielles MapTiler ---
      // Calque clair
      var lightMap = L.maplibreGL({
        style:
          "https://api.maptiler.com/maps/3b544fc3-420c-4a93-a594-a99b71d941bb/style.json?key=BiyHHi8FTQZ233ADqskZ",
        attribution:
          '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a> contributors',
      });

      // Calque sombre
      var darkMap = L.maplibreGL({
        style:
          "https://api.maptiler.com/maps/04c03a5d-804b-4c6f-9736-b7103fdb530b/style.json?key=BiyHHi8FTQZ233ADqskZ",
        attribution:
          '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a> contributors',
      });

      // --- 4. Ajout du fond clair par défaut ---
      lightMap.addTo(map);

    // --- 2. Données GeoJSON pour les salles et les chemins ---
    var salleEtage0 = {
        "type": "FeatureCollection",
        "features": [
        { "type": "Feature", "properties": { "name": "Escalier" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": "14" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132323764318674, 45.93679878003244 ], [ 6.132332645193752, 45.936867696937178 ], [ 6.132169440848435, 45.936875476859768 ], [ 6.132160492656691, 45.936806544549889 ], [ 6.132323764318674, 45.93679878003244 ] ] ] ] } },
       ]
    };

    var salleEtage1 = {
        "type": "FeatureCollection",
        "features": [
        { "type": "Feature", "properties": { "name": "117" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": "115" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132323764318674, 45.93679878003244 ], [ 6.132332645193752, 45.936867696937178 ], [ 6.132169440848435, 45.936875476859768 ], [ 6.132160492656691, 45.936806544549889 ], [ 6.132323764318674, 45.93679878003244 ] ] ] ] } },
        ]
    };

    var salleEtage2 = {
        "type": "FeatureCollection",
"features": [
{ "type": "Feature", "properties": { "name": "V1" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132559263481, 45.937761742137447 ], [ 6.132605358389325, 45.937758765489001 ], [ 6.132614138371865, 45.937824175393722 ], [ 6.132567165465287, 45.937827991605154 ], [ 6.132559263481, 45.937761742137447 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "V2" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132607553384967, 45.937773801378285 ], [ 6.132725973399444, 45.93776700851511 ], [ 6.132730253640932, 45.937817306212494 ], [ 6.132614138371868, 45.937824175393722 ], [ 6.132607553384967, 45.937773801378285 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R11" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R12" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132323764318674, 45.93679878003244 ], [ 6.132332645193752, 45.936867696937178 ], [ 6.132169440848435, 45.936875476859768 ], [ 6.132160492656691, 45.936806544549889 ], [ 6.132323764318674, 45.93679878003244 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R9" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132338097023253, 45.936716667911078 ], [ 6.132346542802771, 45.936781465154866 ], [ 6.132227172282988, 45.936787083013414 ], [ 6.132219251901891, 45.936722066542458 ], [ 6.132338097023253, 45.936716667911078 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R8" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132219253543763, 45.936722064258774 ], [ 6.132227180492344, 45.936787079587916 ], [ 6.132107560408311, 45.936792893842551 ], [ 6.132099429867845, 45.936727498286743 ], [ 6.132219253543763, 45.936722064258774 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R7" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132099431509721, 45.936727500570427 ], [ 6.132116122760606, 45.936862250362864 ], [ 6.132020322927197, 45.936866941039654 ], [ 6.132004120953585, 45.936731824727232 ], [ 6.132099431509721, 45.936727500570427 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R6" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132116189227633, 45.936862186893528 ], [ 6.132124696936733, 45.936927733982991 ], [ 6.132030014367759, 45.936932969021719 ], [ 6.132034131001193, 45.936967051293124 ], [ 6.131986299641299, 45.936969668810697 ], [ 6.131974067359097, 45.936869957663198 ], [ 6.132020328027306, 45.936866941377744 ], [ 6.132116189227633, 45.936862186893528 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R5" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132038113848223, 45.936998476904492 ], [ 6.132133756964997, 45.936993473628341 ], [ 6.132151611175407, 45.937134784331924 ], [ 6.132055007510834, 45.937140237480925 ], [ 6.132038113848223, 45.936998476904492 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "V18" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132302978019801, 45.937163950166401 ], [ 6.132305228465431, 45.937189553478937 ], [ 6.132287198591141, 45.937205146048541 ], [ 6.13226320449913, 45.937221778117973 ], [ 6.132204028302615, 45.937188433835416 ], [ 6.132202875929909, 45.937181011218328 ], [ 6.132226636757653, 45.937179541959814 ], [ 6.132225100260709, 45.93716845573524 ], [ 6.132302978019801, 45.937163950166401 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Escalier" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132429212643101, 45.936677276337036 ], [ 6.132434054588134, 45.936712841350747 ], [ 6.132395279821793, 45.936744510723749 ], [ 6.132342136044464, 45.936747360012134 ], [ 6.132338097823097, 45.936716658581339 ], [ 6.132385145062337, 45.936678840720951 ], [ 6.132429212643101, 45.936677276337036 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Sanitaire" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132322925088437, 45.936918998692519 ], [ 6.132327943460623, 45.936952494757485 ], [ 6.132285071663862, 45.936986031700897 ], [ 6.132232463785305, 45.936988325741943 ], [ 6.132229085449164, 45.936950899707192 ], [ 6.132270918286057, 45.936921370819881 ], [ 6.132322925088437, 45.936918998692519 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "V16" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132517020961398, 45.937206389313879 ], [ 6.132524758321008, 45.937254092469317 ], [ 6.13251274071991, 45.937254970206972 ], [ 6.132515978338468, 45.937274356757314 ], [ 6.132441554267732, 45.937278955337604 ], [ 6.132430647883178, 45.937212151857189 ], [ 6.132517020961398, 45.937206389313879 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "R4" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.13215159180801, 45.937134835398332 ], [ 6.132163770367505, 45.937229463372603 ], [ 6.132067401939128, 45.93723538001754 ], [ 6.132055053263787, 45.937140213042852 ], [ 6.13215159180801, 45.937134835398332 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Escalier" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132124809654063, 45.936927665818267 ], [ 6.132129592790053, 45.936961966219414 ], [ 6.132034184909476, 45.936967024027155 ], [ 6.132030019268502, 45.936932969021555 ], [ 6.132124809654063, 45.936927665818267 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Adjoint" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132127490366544, 45.937332306272104 ], [ 6.132086245620142, 45.93736513407989 ], [ 6.132037159667203, 45.937368187828461 ], [ 6.132032611767408, 45.937336232522568 ], [ 6.132076130463709, 45.937303254736648 ], [ 6.132127490366544, 45.937332306272104 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Coordinateur secteurs" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132138673887373, 45.937393728884139 ], [ 6.132143378611296, 45.937427101967195 ], [ 6.132192150915976, 45.937424484471208 ], [ 6.132237002617387, 45.937389093732136 ], [ 6.132232297893465, 45.93738816670168 ], [ 6.132208382213516, 45.937374043118204 ], [ 6.132182092065031, 45.937359878840439 ], [ 6.132138673887373, 45.937393728884139 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": null }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132257849899189, 45.9373207431655 ], [ 6.132265525705262, 45.937386943240583 ], [ 6.13223712023548, 45.937388848341719 ], [ 6.132236983014368, 45.937389039200923 ], [ 6.132232337099492, 45.93738816670168 ], [ 6.132208441022562, 45.937374084016618 ], [ 6.132231729405984, 45.937355952383939 ], [ 6.132206212152012, 45.937339523948609 ], [ 6.132226403539401, 45.937323281053075 ], [ 6.132257849899189, 45.9373207431655 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": null }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132308071095699, 45.9372562104884 ], [ 6.132359433993545, 45.937284221761089 ], [ 6.132264665057027, 45.937290747546015 ], [ 6.132308071095699, 45.9372562104884 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "Dessin GC - R3" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132257959648957, 45.937320732088672 ], [ 6.132446383258118, 45.937308855641085 ], [ 6.132457385673736, 45.937376307766222 ], [ 6.132265644031364, 45.937386943240483 ], [ 6.132257959648957, 45.937320732088672 ] ] ] ] } },
]
    };

    var CheminEtage0 = {
        "type": "FeatureCollection",
"features":[
        {"type":"Feature","properties":{"name":"8","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13217,45.93707],[6.13212,45.93707]]}},
        {"type":"Feature","properties":{"name":"10","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.1321,45.93685],[6.13215,45.93685]]}},
        {"type":"Feature","properties":{"name":"Réunion","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13273,45.93773],[6.13269,45.93776]]}},
        {"type":"Feature","properties":{"name":"1","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13276,45.93756],[6.13276,45.93759]]}},
        {"type":"Feature","properties":{"name":"6","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13232,45.9373],[6.13232,45.93733]]}},
        {"type":"Feature","properties":{"name":"11","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13214,45.93677],[6.13215,45.9368]]}},
        {"type":"Feature","properties":{"name":"14","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13229,45.93681],[6.13228,45.93679]]}},
        {"type":"Feature","properties":{"name":"CDI","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13266,45.93761],[6.13261,45.93761]]}},
        {"type":"Feature","properties":{"name":"Proviseur","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13285,45.9375],[6.13285,45.93747]]}},
        {"type":"Feature","properties":{"name":"0","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13218,45.93707],[6.13223,45.93707]]}},
        {"type":"Feature","properties":{"name":"12","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13225,45.93677],[6.13225,45.93679]]}},
        {"type":"Feature","properties":{"name":"Acceuil","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13284,45.93754],[6.13287,45.93756]]}},
        {"type":"Feature","properties":{"name":"7","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13219,45.93717],[6.13214,45.93718]]}},
        {"type":"Feature","properties":{"name":"7.8","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13218,45.93714],[6.13213,45.93714]]}},
        {"type":"Feature","properties":{"name":"13","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13242,45.9368],[6.13242,45.93678]]}},
        {"type":"Feature","properties":{"name":"2","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13266,45.9376],[6.13272,45.93761]]}},
        {"type":"Feature","properties":{"name":"Intendance","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13264,45.9374],[6.1327,45.9374]]}},
        {"type":"Feature","properties":{"name":"Vie scolaire","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13237,45.9373],[6.13237,45.93732]]}},
        {"type":"Feature","properties":{"name":"9","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13215,45.93687],[6.13209,45.93688]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E105","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13148,45.93734],[6.13148,45.93738]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E108","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13144,45.93741],[6.13148,45.9374]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M105","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13173,45.93679],[6.13174,45.93681]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M101","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13179,45.93695],[6.13175,45.93695]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E109 Prof","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13123,45.93737],[6.13121,45.93737]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M109","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13168,45.93699],[6.13164,45.93699]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E104","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13171,45.93743],[6.1317,45.93738]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M106","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13171,45.93721],[6.13167,45.93721]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E103","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13161,45.93736],[6.13161,45.93739]]}},
        {"type":"Feature","properties":{"bridge":"yes","foot":"yes","highway":"footway","layer":"-1","name":"M108.1"},"geometry":{"type":"LineString","coordinates":[[6.13177,45.93699],[6.13177,45.93701]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M102","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13178,45.93687],[6.13174,45.93688]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E102","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13182,45.93739],[6.13176,45.93739],[6.13175,45.93739]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M106.1","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13172,45.93724],[6.13171,45.93721]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E107","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13141,45.93737],[6.13148,45.93738]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E101","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13177,45.93735],[6.13176,45.93739]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M110","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13168,45.93726],[6.13168,45.93724]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M104 Prof","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13164,45.93686],[6.13164,45.93684]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M108","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13171,45.93704],[6.13165,45.93705]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"M103","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.1317,45.93695],[6.13175,45.93695]]}},
        {"type":"Feature","properties":{"bridge":"yes","name":"E106","highway":"footway","foot":"yes","layer":"-1"},"geometry":{"type":"LineString","coordinates":[[6.13153,45.93743],[6.13153,45.9374]]}},
      ]
    };
    var CheminEtage1 = {
      "type": "FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"116"},"geometry":{"type":"LineString","coordinates":[[6.13218,45.93718],[6.13214,45.93718]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"113"},"geometry":{"type":"LineString","coordinates":[[6.13216,45.93702],[6.13221,45.93701]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"106"},"geometry":{"type":"LineString","coordinates":[[6.13266,45.93757],[6.13262,45.93757]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"115"},"geometry":{"type":"LineString","coordinates":[[6.1322,45.93681],[6.1322,45.9368]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"Audio visuel"},"geometry":{"type":"LineString","coordinates":[[6.13275,45.93753],[6.13275,45.93756]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"101"},"geometry":{"type":"LineString","coordinates":[[6.13267,45.93766],[6.13273,45.93766]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"103"},"geometry":{"type":"LineString","coordinates":[[6.13263,45.93739],[6.13269,45.93738]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"108"},"geometry":{"type":"LineString","coordinates":[[6.13265,45.9375],[6.13259,45.93751]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"109"},"geometry":{"type":"LineString","coordinates":[[6.1324,45.9373],[6.13239,45.93727]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"Labo"},"geometry":{"type":"LineString","coordinates":[[6.13215,45.93687],[6.1321,45.93687]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"118"},"geometry":{"type":"LineString","coordinates":[[6.13217,45.93708],[6.13211,45.93708]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"117"},"geometry":{"type":"LineString","coordinates":[[6.13242,45.93678],[6.13242,45.9368]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"104"},"geometry":{"type":"LineString","coordinates":[[6.13266,45.9376],[6.13261,45.9376]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"114"},"geometry":{"type":"LineString","coordinates":[[6.13235,45.9373],[6.13235,45.93733]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"Video lecture"},"geometry":{"type":"LineString","coordinates":[[6.13274,45.93753],[6.13273,45.9375]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"124"},"geometry":{"type":"LineString","coordinates":[[6.13224,45.93678],[6.13224,45.93679]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"110"},"geometry":{"type":"LineString","coordinates":[[6.13264,45.93741],[6.13257,45.93742]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"107"},"geometry":{"type":"LineString","coordinates":[[6.13257,45.93729],[6.13257,45.93725]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"1"},"geometry":{"type":"LineString","coordinates":[[6.13271,45.93771],[6.13268,45.93775]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"120"},"geometry":{"type":"LineString","coordinates":[[6.13216,45.93697],[6.13211,45.93698]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"122"},"geometry":{"type":"LineString","coordinates":[[6.13215,45.93681],[6.1321,45.93681]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"111"},"geometry":{"type":"LineString","coordinates":[[6.13217,45.93711],[6.13221,45.93711]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"Germain somelier"},"geometry":{"type":"LineString","coordinates":[[6.13324,45.9375],[6.13318,45.93746]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"102"},"geometry":{"type":"LineString","coordinates":[[6.13267,45.93767],[6.13262,45.93767]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"112"},"geometry":{"type":"LineString","coordinates":[[6.13243,45.9373],[6.13243,45.93733]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"105"},"geometry":{"type":"LineString","coordinates":[[6.13263,45.93731],[6.13268,45.9373]]}},

      ]
    };


    var CheminEtage2 = {
      "type": "FeatureCollection",
        "features":[
        {"type":"Feature","properties":{"foot":"yes","name":"V7","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13288,45.9375],[6.13285,45.9375]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V19","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13224,45.93712],[6.13218,45.93713]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R2 STS Bâtiment","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13258,45.93754],[6.13265,45.93753]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V3","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13275,45.93766],[6.13266,45.93767]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V10","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.93744],[6.13264,45.93745]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"Adjoint","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13208,45.93733],[6.13215,45.93735]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R11","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13238,45.93681],[6.13238,45.93679]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R1 STS Bâtiment","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1326,45.93768],[6.13267,45.93768]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"VDI0","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1327,45.93733],[6.13263,45.93734]]}},
        {"type":"Feature","properties":{"layer":"-2","highway":"footway","tunnel":"yes","name":"V11","foot":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.93736],[6.13263,45.93736]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R6","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13206,45.93689],[6.13215,45.93688]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V4","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13273,45.9376],[6.13266,45.93759]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V17","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13237,45.93725],[6.13238,45.93729]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V20","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13223,45.9371],[6.13217,45.9371]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"Dessin GC - R3","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13229,45.93736],[6.13228,45.9373]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R11","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13219,45.93682],[6.13219,45.9368]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V1","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13259,45.93777],[6.13262,45.93777]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"2","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13211,45.9373],[6.13216,45.93733]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R8","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13211,45.93678],[6.13213,45.9368]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V2","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.9378],[6.13268,45.93775]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R7","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13207,45.93684],[6.13214,45.93684]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V9","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.93747],[6.13264,45.93748]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V21","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13219,45.93702],[6.1322,45.93704]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V5","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1328,45.93758],[6.13279,45.93753]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"GC Profs","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13247,45.93733],[6.1325,45.93731]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R9","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13224,45.93676],[6.13225,45.93679]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V18","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13223,45.9372],[6.13221,45.93717]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V15","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13259,45.93725],[6.13259,45.93728]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V8","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13279,45.9375],[6.13279,45.93753]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R5","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13209,45.93703],[6.13216,45.93702]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V6","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13288,45.93756],[6.13286,45.93756]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"R4","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1321,45.93716],[6.13218,45.93715]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"Coordinateur secteurs","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13219,45.93738],[6.13217,45.93736]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V16","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13245,45.93726],[6.13246,45.93729]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V14","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13262,45.93723],[6.13266,45.93726]]}},
        {"type":"Feature","properties":{"foot":"yes","name":"V13","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.93727],[6.13266,45.93726]]}},
        {"type":"Feature","properties":{"name":"E15","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.131,45.93756],[6.131,45.93752]]}},
        {"type":"Feature","properties":{"name":"M2.3","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13156,45.93717],[6.13156,45.93713]]}},
        {"type":"Feature","properties":{"name":"M19","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13172,45.93691],[6.13159,45.93689]]}},
        {"type":"Feature","properties":{"name":"E9","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13137,45.93735],[6.13136,45.93733]]}},
        {"type":"Feature","properties":{"name":"M16 Prof","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13144,45.93668],[6.13144,45.93669],[6.13144,45.93672]]}},
        {"type":"Feature","properties":{"name":"E4","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13172,45.93744],[6.13172,45.9374]]}},
        {"type":"Feature","properties":{"name":"E17","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13105,45.93731],[6.13118,45.9373]]}},
        {"type":"Feature","properties":{"name":"M8","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13103,45.93704],[6.1311,45.93704]]}},
        {"type":"Feature","properties":{"name":"M2","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13158,45.93706],[6.1316,45.93701]]}},
        {"type":"Feature","properties":{"name":"E2","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13178,45.93738],[6.1318,45.93735]]}},
        {"type":"Feature","properties":{"name":"E11","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13125,45.93739],[6.13119,45.9374]]}},
        {"type":"Feature","properties":{"name":"M6","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13126,45.93699],[6.13126,45.93701]]}},
        {"type":"Feature","properties":{"name":"M12","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13158,45.93669],[6.13159,45.93673]]}},
        {"type":"Feature","properties":{"name":"M2.2","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13164,45.93717],[6.13163,45.93712]]}},
        {"type":"Feature","properties":{"name":"E3","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1316,45.93733],[6.13165,45.93731]]}},
        {"type":"Feature","properties":{"name":"M13","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1315,45.9367],[6.1315,45.93674]]}},
        {"type":"Feature","properties":{"name":"M2.5","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13143,45.93708],[6.13143,45.93705]]}},
        {"type":"Feature","properties":{"name":"M17","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13177,45.93692],[6.13172,45.93691]]}},
        {"type":"Feature","properties":{"name":"M14","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13138,45.93673],[6.13144,45.93673]]}},
        {"type":"Feature","properties":{"name":"M1.4","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13113,45.93712],[6.13113,45.93704]]}},
        {"type":"Feature","properties":{"name":"M2.1 Prof","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13176,45.93723],[6.1317,45.93723]]}},
        {"type":"Feature","properties":{"name":"M1.3","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13116,45.93724],[6.13117,45.93729]]}},
        {"type":"Feature","properties":{"name":"Entretien","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1314,45.93732],[6.13136,45.93732]]}},
        {"type":"Feature","properties":{"name":"12","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13119,45.93749],[6.13117,45.93747]]}},
        {"type":"Feature","properties":{"name":"M9","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13156,45.93686],[6.13146,45.93687]]}},
        {"type":"Feature","properties":{"name":"E1","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13178,45.93738],[6.1318,45.93735]]}},
        {"type":"Feature","properties":{"name":"E10 Entretien atelier","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13126,45.93734],[6.13125,45.93729]]}},
        {"type":"Feature","properties":{"name":"M11 Prof","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13167,45.93669],[6.13167,45.93673]]}},
        {"type":"Feature","properties":{"name":"E16","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1309,45.93752],[6.13086,45.93752]]}},
        {"type":"Feature","properties":{"name":"M4","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13173,45.93703],[6.13168,45.93704]]}},
        {"type":"Feature","properties":{"name":"Magasin","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13131,45.93732],[6.13136,45.93732]]}},
        {"type":"Feature","properties":{"name":"13","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13109,45.9374],[6.13104,45.9374]]}},
        {"type":"Feature","properties":{"name":"E6","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13148,45.93732],[6.13148,45.93727]]}},
        {"type":"Feature","properties":{"name":"M16","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13136,45.9367],[6.13144,45.93669]]}},
        {"type":"Feature","properties":{"name":"E14","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13102,45.93736],[6.13103,45.93736],[6.13107,45.93736]]}},
        {"type":"Feature","properties":{"name":"M7","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13117,45.93696],[6.13118,45.93704]]}},
        {"type":"Feature","properties":{"name":"M20","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13164,45.93677],[6.13164,45.93673]]}},
        {"type":"Feature","properties":{"name":"E5","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13166,45.9374],[6.13172,45.93739]]}},
        {"type":"Feature","properties":{"name":"M5 Prof","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13131,45.93697],[6.13131,45.93699]]}},
        {"type":"Feature","properties":{"name":"M2.4","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.1315,45.93716],[6.1315,45.93714]]}},
        {"type":"Feature","properties":{"name":"E7","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13145,45.93732],[6.13145,45.93728]]}},
        {"type":"Feature","properties":{"name":"M18","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13175,45.93673],[6.1317,45.93673]]}},
        {"type":"Feature","properties":{"name":"M1","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13132,45.93716],[6.13125,45.93716]]}},
        {"type":"Feature","properties":{"name":"E15","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.131,45.93756],[6.131,45.93752]]}},
        {"type":"Feature","properties":{"name":"M2.3","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13156,45.93717],[6.13156,45.93713]]}},
        {"type":"Feature","properties":{"name":"M19","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13172,45.93691],[6.13159,45.93689]]}},
        {"type":"Feature","properties":{"name":"M3","highway":"footway","foot":"yes","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13175,45.93719],[6.1317,45.93719]]}},
]};


    // --- 2. Données GeoJSON pour les salles et les chemins ---
    var salleEtage0 = {
        "type": "FeatureCollection",
        "features": [
        { "type": "Feature", "properties": { "name": "13" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": "14" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132323764318674, 45.93679878003244 ], [ 6.132332645193752, 45.936867696937178 ], [ 6.132169440848435, 45.936875476859768 ], [ 6.132160492656691, 45.936806544549889 ], [ 6.132323764318674, 45.93679878003244 ] ] ] ] } },
       ]
    };

    var salleEtage1 = {
        "type": "FeatureCollection",
        "features": [
        { "type": "Feature", "properties": { "name": "117" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132443855592967, 45.936792791783532 ], [ 6.132451800410498, 45.936862076107261 ], [ 6.132332645198166, 45.936867696926917 ], [ 6.132323764318674, 45.936798784599809 ], [ 6.132443855592967, 45.936792791783532 ] ] ] ] } },
        { "type": "Feature", "properties": { "name": "115" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132323764318674, 45.93679878003244 ], [ 6.132332645193752, 45.936867696937178 ], [ 6.132169440848435, 45.936875476859768 ], [ 6.132160492656691, 45.936806544549889 ], [ 6.132323764318674, 45.93679878003244 ] ] ] ] } },
        ]
    };

    var salleEtage2 = {
        "type": "FeatureCollection",
"features": [
{ "type": "Feature", "properties": { "name": "V1" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132559263481, 45.937761742137447 ], [ 6.132605358389325, 45.937758765489001 ], [ 6.132614138371865, 45.937824175393722 ], [ 6.132567165465287, 45.937827991605154 ], [ 6.132559263481, 45.937761742137447 ] ] ] ] } },
{ "type": "Feature", "properties": { "name": "V2" }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ 6.132607553384967, 45.937773801378285 ], [ 6.132725973399444, 45.93776700851511 ], [ 6.132730253640932, 45.937817306212494 ], [ 6.132614138371868, 45.937824175393722 ], [ 6.132607553384967, 45.937773801378285 ] ] ] ] } },
]
    };

    var CheminEtage0 = {
        "type": "FeatureCollection",
"features":[
        {"type":"Feature","properties":{"name":"14","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13229,45.93681],[6.13228,45.93679]]}},
        {"type":"Feature","properties":{"name":"13","foot":"yes","highway":"footway"},"geometry":{"type":"LineString","coordinates":[[6.13242,45.9368],[6.13242,45.93678]]}},
      ]
    };

    var CheminEtage1 = {
      "type": "FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"115"},"geometry":{"type":"LineString","coordinates":[[6.1322,45.93681],[6.1322,45.9368]]}},
        {"type":"Feature","properties":{"highway":"footway","foot":"yes","name":"117"},"geometry":{"type":"LineString","coordinates":[[6.13242,45.93678],[6.13242,45.9368]]}},

      ]
    };

    var CheminEtage2 = {
      "type": "FeatureCollection",
        "features":[
{"type":"Feature","properties":{"foot":"yes","name":"V1","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13259,45.93777],[6.13262,45.93777]]}},
{"type":"Feature","properties":{"foot":"yes","name":"V2","highway":"footway","layer":"-2","tunnel":"yes"},"geometry":{"type":"LineString","coordinates":[[6.13272,45.9378],[6.13268,45.93775]]}},
]};


// Fonction pour basculer entre les thèmes
function toggleTheme() {
    document.body.classList.toggle('dark-mode');
    const toggleButton = document.getElementById('dark-mode-toggle');
    
    // Vérifier si le mode sombre est activé
    if (document.body.classList.contains('dark-mode')) {
        map.removeLayer(lightMap);
        map.addLayer(darkMap);
        
        // Changer l'icône à partir de l'image dans le dossier ./images
        toggleButton.innerHTML = '<img src="./images/light-icon.png" alt="Mode clair" class="theme-icon"/>'; // Remplacez par votre icône de soleil
    } else {
        map.removeLayer(darkMap);
        map.addLayer(lightMap);
        
        // Changer l'icône à partir de l'image dans le dossier ./images
        toggleButton.innerHTML = '<img src="./images/dark-icon.png" alt="Mode sombre" class="theme-icon"/>'; // Remplacez par votre icône de lune
    }
}


      // Détecter le thème préféré de l'utilisateur
      const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

      if (prefersDarkScheme.matches) {
          document.body.classList.add('dark-mode');
          const toggleButton = document.getElementById('dark-mode-toggle');
          toggleButton.innerHTML = '<img src="./images/light-icon.png" alt="Mode clair" class="theme-icon"/>'; // Icône du soleil
          map.removeLayer(lightMap);
          map.addLayer(darkMap);
      } else {
          document.body.classList.remove('dark-mode');
          const toggleButton = document.getElementById('dark-mode-toggle');
          toggleButton.innerHTML = '<img src="./images/dark-icon.png" alt="Mode sombre" class="theme-icon"/>'; // Icône de la lune
          map.removeLayer(darkMap);
          map.addLayer(lightMap);
      }


      // Ajouter l'événement de clic pour le bouton de basculement
      document.getElementById('dark-mode-toggle').addEventListener('click', toggleTheme);

      // --- 3. Création des couches GeoJSON pour les salles ---
      // On n'utilise plus bindTooltip ici afin d'éviter que le label s'affiche automatiquement au survol.
      function onEachSalleFeature(feature, layer, floor) {
        feature.properties.floor = floor;
        // Pour l'étage 1, si la propriété "name" est absente, on la copie depuis "salle"
        if (
          floor === "1" &&
          !feature.properties.name &&
          feature.properties.salle
        ) {
          feature.properties.name = feature.properties.salle;
        }
        layer.on({
          mouseover: function (e) {
            e.target.setStyle({
              fillOpacity: 1,
              weight: 3,
            });
          },
          mouseout: function (e) {
            if (floor === "0") {
              salleLayer0.resetStyle(e.target);
            } else if (floor === "1") {
              salleLayer1.resetStyle(e.target);
            } else if (floor === "2") {
              salleLayer2.resetStyle(e.target);
            }
          },
          click: function (e) {
            // Supprimer l'appel à resetHighlight() pour conserver les labels
            // Zoom sur la feature cliquée
            map.fitBounds(e.target.getBounds());
          },
        });
      }

      var salleLayer0 = L.geoJSON(salleEtage0, {
        style: function (feature) {
          return { color: "#146414", weight: 2, fillOpacity: 0.9 };
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "0");
        },
      });

      var salleLayer1 = L.geoJSON(salleEtage1, {
        style: function (feature) {
          return { color: "#2B942B", weight: 2, fillOpacity: 0.9 };
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "1");
        },
      });

      var salleLayer2 = L.geoJSON(salleEtage2, {
        style: function (feature) {
          return { color: "#093209", weight: 2, fillOpacity: 0.9 }; // modifiez la couleur au besoin
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "2");
        },
      });

      // --- 4. Calque des chemins ---

      var CheminEtageLayer0 = L.geoJSON(CheminEtage0, {
        style: { color: "transparent" },
      });

      var CheminEtageLayer1 = L.geoJSON(CheminEtage1, {
        style: { color: "transparent" },
      });

      var CheminEtageLayer2 = L.geoJSON(CheminEtage2, {
        style: { color: "transparent" },
      });

      // --- 5. Couches d'itinéraire (initialement vides) ---
      var itinéraireEtage0 = { type: "FeatureCollection", features: [] };
      var itinéraireEtage1 = { type: "FeatureCollection", features: [] };
      var itinéraireEtage2 = { type: "FeatureCollection", features: [] };

      var itinéraireLayer0 = L.geoJSON(itinéraireEtage0, {
        style: { color: "#3564FF", weight: 10 },
      });
      var itinéraireLayer1 = L.geoJSON(itinéraireEtage1, {
        style: { color: "#3564FF", weight: 10 },
      });
      var itinéraireLayer2 = L.geoJSON(itinéraireEtage2, {
        style: { color: "#FFA500", weight: 5 },
      });

      // --- 6. Fonds de carte personnalisés pour chaque groupe (en plus du fond par défaut) ---
      var customBackground0 = L.tileLayer(
        "../Données/QGIS/QTiles/etage0/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );
      var customBackground1 = L.tileLayer(
        "../Données/QGIS/QTiles/etage1/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );
      var customBackground2 = L.tileLayer(
        "../Données/QGIS/QTiles/etage2/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );

      // --- 7. Groupes par étage en ajoutant le fond personnalisé dans le groupe ---
      var etage0 = L.layerGroup([
        customBackground0,
        salleLayer0,
        itinéraireLayer0,
        CheminEtageLayer0,
      ]);
      var etage1 = L.layerGroup([
        customBackground1,
        salleLayer1,
        itinéraireLayer1,
        CheminEtageLayer1,
      ]);
      var etage2 = L.layerGroup([
        customBackground2,
        salleLayer2,
        itinéraireLayer2,
        CheminEtageLayer2,
      ]);
      // Par défaut, le groupe de l'étage 0 est affiché.
      etage0.addTo(map);

      // --- 8. Gestion des labels (tooltips) en fonction du niveau de zoom ---
      const tooltipZoomThreshold = 20; // Seuil de zoom pour afficher les labels
      const arrowZoomThreshold = 20; // Seuil de zoom pour afficher les flèches

      function updateTooltipsVisibility() {
        var currentZoom = map.getZoom();

        function toggleTooltips(layerGroup) {
          layerGroup.eachLayer(function (layer) {
            if (currentZoom >= tooltipZoomThreshold) {
              if (!layer._customTooltip) {
                var labelContent =
                  layer.feature.properties.name ||
                  layer.feature.properties.salle;
                if (labelContent) {
                  var center = layer.getBounds().getCenter();
                  var tooltip = L.tooltip({
                    permanent: true,
                    direction: "center",
                    className: "room-label",
                  })
                    .setContent(labelContent)
                    .setLatLng(center);
                  tooltip.addTo(map);
                  layer._customTooltip = tooltip;
                }
              }
            } else if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 0
        if (map.hasLayer(etage0)) {
          toggleTooltips(salleLayer0);
        } else {
          salleLayer0.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 1
        if (map.hasLayer(etage1)) {
          toggleTooltips(salleLayer1);
        } else {
          salleLayer1.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 2
        if (map.hasLayer(etage2)) {
          toggleTooltips(salleLayer2);
        } else {
          salleLayer2.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        updateArrowsVisibility();
        updateButtonsVisibility();
      }

      function updateArrowsVisibility() {
        var currentZoom = map.getZoom();
      
        function toggleArrows(layerGroup) {
          var arrowLayers = [];
          layerGroup.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator) {
              if (currentZoom >= arrowZoomThreshold) {
                if (!map.hasLayer(layer)) {
                  arrowLayers.push(layer);
                }
              } else {
                if (map.hasLayer(layer)) {
                  map.removeLayer(layer);
                }
              }
            }
            });
          // Add arrow layers after all polylines have been added
          arrowLayers.forEach((arrow) => {
            map.addLayer(arrow);
            arrow.bringToFront(); // Ensure the arrow is on top
          });
        }
      
        if (map.hasLayer(etage0)) {
          toggleArrows(itinéraireLayer0);
        } else {
          itinéraireLayer0.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }
      
        if (map.hasLayer(etage1)) {
          toggleArrows(itinéraireLayer1);
        } else {
          itinéraireLayer1.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }
      
        if (map.hasLayer(etage2)) {
          toggleArrows(itinéraireLayer2);
        } else {
          itinéraireLayer2.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }
      }
      
// --- Nouvelle fonctionnalité : Boutons sur les formes GeoJSON ---
const buttonZoomThreshold = 22; // Seuil de zoom pour afficher les boutons

function updateButtonsVisibility() {
  var currentZoom = map.getZoom();

  function toggleButtons(layerGroup) {
    layerGroup.eachLayer(function (layer) {
      if (currentZoom >= buttonZoomThreshold) {
        if (!layer._customButton) {
          var center = layer.getBounds().getCenter();
          var btnMarker = L.marker(center, {
            icon: L.divIcon({
              html: '<div style="display: flex; flex-direction: column; align-items: center;"><button class="custom-geojson-button"><img src="./images/starticon.png" alt="Start Icon" style="width: 16px; height: 16px; margin-right: 5px;">Start</button><br><button class="custom-geojson-button"><img src="./images/endicon.png" alt="End Icon" style="width: 16px; height: 16px; margin-right: 5px;">End</button></div>',
              className: '', // Pas de class supplémentaire ici
              iconSize: [30, 60],
              iconAnchor: [15, -15], // Adjusted to move the buttons below the labels
            }),
            interactive: true
          }).addTo(map);

          // Gestion du clic sur le bouton "Start"
          btnMarker.on("click", function (e) {
            if (e.originalEvent.target.innerText === "Start") {
              // Supprimer le précédent point de départ s'il existe
              if (startPoint) {
                map.removeLayer(startPoint);
                startPoint = null;
              }
              // Récupérer le nom et l'étage de la salle associée
              var key = layer.feature.properties.name || layer.feature.properties.salle;
              var floor = layer.feature.properties.floor;
              
              // Rechercher dans la couche active toutes les formes correspondant au même nom
              var matchingFeatures = [];
              var activeLayer = map.hasLayer(etage0)
                ? salleLayer0
                : map.hasLayer(etage1)
                ? salleLayer1
                : salleLayer2;
              activeLayer.eachLayer(function (l) {
                var lKey = l.feature.properties.name || l.feature.properties.salle;
                if (lKey === key) {
                  matchingFeatures.push(l);
                }
              });
              if (matchingFeatures.length > 0) {
                var group = L.featureGroup(matchingFeatures);
                map.fitBounds(group.getBounds());
                matchingFeatures.forEach(function (l) {
                  highlightFeature(l);
                });
              }
              
              // Sélectionner le calque chemin correspondant à l'étage
              var cheminLayer =
                floor === "0"
                  ? CheminEtageLayer0
                  : floor === "1"
                  ? CheminEtageLayer1
                  : CheminEtageLayer2;
              var cheminFeature = null;
              cheminLayer.eachLayer(function (clayer) {
                var clayerKey = clayer.feature.properties.name || clayer.feature.properties.salle;
                if (clayer.feature && clayerKey === key) {
                  cheminFeature = clayer;
                }
              });
              if (cheminFeature) {
                var centerChemin = cheminFeature.getBounds().getCenter();
                startPoint = L.marker(centerChemin, { icon: StartIcon, floor: floor })
                  .addTo(map)
                  .bindPopup(
                    "Point de départ sur le chemin de " + key,
                    { autoPan: false }
                  )
                  .openPopup();
              }
              updateMarkersVisibility();
              checkAndCalculateRoute();
            }
          });

          // Gestion du clic sur le bouton "End"
          btnMarker.on("click", function (e) {
            if (e.originalEvent.target.innerText === "End") {
              // Supprimer le précédent point d'arrivée s'il existe
              if (endPoint) {
                map.removeLayer(endPoint);
                endPoint = null;
              }
              // Récupérer le nom et l'étage de la salle associée
              var key = layer.feature.properties.name || layer.feature.properties.salle;
              var floor = layer.feature.properties.floor;
              
              // Rechercher dans la couche active toutes les formes correspondant au même nom
              var matchingFeatures = [];
              var activeLayer = map.hasLayer(etage0)
                ? salleLayer0
                : map.hasLayer(etage1)
                ? salleLayer1
                : salleLayer2;
              activeLayer.eachLayer(function (l) {
                var lKey = l.feature.properties.name || l.feature.properties.salle;
                if (lKey === key) {
                  matchingFeatures.push(l);
                }
              });
              if (matchingFeatures.length > 0) {
                var group = L.featureGroup(matchingFeatures);
                map.fitBounds(group.getBounds());
                matchingFeatures.forEach(function (l) {
                  highlightFeature(l);
                });
              }
              
              // Sélectionner le calque chemin correspondant à l'étage
              var cheminLayer =
                floor === "0"
                  ? CheminEtageLayer0
                  : floor === "1"
                  ? CheminEtageLayer1
                  : CheminEtageLayer2;
              var cheminFeature = null;
              cheminLayer.eachLayer(function (clayer) {
                var clayerKey = clayer.feature.properties.name || clayer.feature.properties.salle;
                if (clayer.feature && clayerKey === key) {
                  cheminFeature = clayer;
                }
              });
              if (cheminFeature) {
                var centerChemin = cheminFeature.getBounds().getCenter();
                endPoint = L.marker(centerChemin, { icon: EndIcon, floor: floor })
                  .addTo(map)
                  .bindPopup(
                    "Point d'arrivée sur le chemin de " + key,
                    { autoPan: false }
                  )
                  .openPopup();
              }
              updateMarkersVisibility();
              checkAndCalculateRoute();
            }
          });

          layer._customButton = btnMarker;
        }
      } else if (layer._customButton) {
        map.removeLayer(layer._customButton);
        layer._customButton = null;
      }
    });
  }

  // Appliquer selon l'étage actif
  if (map.hasLayer(etage0)) {
    toggleButtons(salleLayer0);
  } else {
    salleLayer0.eachLayer(function (layer) {
      if (layer._customButton) {
        map.removeLayer(layer._customButton);
        layer._customButton = null;
      }
    });
  }

  if (map.hasLayer(etage1)) {
    toggleButtons(salleLayer1);
  } else {
    salleLayer1.eachLayer(function (layer) {
      if (layer._customButton) {
        map.removeLayer(layer._customButton);
        layer._customButton = null;
      }
    });
  }

  if (map.hasLayer(etage2)) {
    toggleButtons(salleLayer2);
  } else {
    salleLayer2.eachLayer(function (layer) {
      if (layer._customButton) {
        map.removeLayer(layer._customButton);
        layer._customButton = null;
      }
    });
  }
}

      map.on("zoomend", updateTooltipsVisibility);
            // Listen for layer changes and update tooltips
            map.on("baselayerchange", function (e) {
        updateTooltipsVisibility();
        updateMarkersVisibility();
        updateArrowsVisibility();
      });

      map.on("zoomend", function () {
        updateTooltipsVisibility();
        updateButtonsVisibility();
      });

      map.on("baselayerchange", function (e) {
        updateTooltipsVisibility();
        updateMarkersVisibility();
        updateArrowsVisibility();
        updateButtonsVisibility(); // Add this line to update buttons visibility on layer change
      });

      // --- 9. Basculement automatique du calque en fonction de la salle recherchée ---
      // Fonction pour vérifier si une salle existe sur le calque actif
      function salleExistsOnActiveLayer(salleName) {
  // Si le nom recherché n'est pas valide, retourner false pour forcer le basculement
  if (!salleName || salleName === "null") {
    return false;
  }
  var activeLayer = null;
  if (map.hasLayer(etage0)) {
    activeLayer = salleLayer0;
  } else if (map.hasLayer(etage1)) {
    activeLayer = salleLayer1;
  } else if (map.hasLayer(etage2)) {
    activeLayer = salleLayer2;
  }
  if (activeLayer) {
    var exists = false;
    activeLayer.eachLayer(function (layer) {
      var layerKey = layer.feature.properties.name || layer.feature.properties.salle;
      // Ne pas tenir compte des noms invalides
      if (!layerKey || layerKey === "null") {
        return;
      }
      if (layerKey === salleName) {
        exists = true;
      }
    });
    return exists;
  }
  return false;
}

      // Modifiez la fonction switchFloor pour utiliser la vérification et effectuer le zoom
      function switchFloor(floor, salleName) {
  // Supprime tous les tooltips personnalisés pour tous les calques
  salleLayer0.eachLayer(function (layer) {
    if (layer._customTooltip) {
      map.removeLayer(layer._customTooltip);
      layer._customTooltip = null;
    }
  });
  salleLayer1.eachLayer(function (layer) {
    if (layer._customTooltip) {
      map.removeLayer(layer._customTooltip);
      layer._customTooltip = null;
    }
  });
  salleLayer2.eachLayer(function (layer) {
    if (layer._customTooltip) {
      map.removeLayer(layer._customTooltip);
      layer._customTooltip = null;
    }
  });

  // Vérifiez si la salle existe sur le calque actif
  if (salleExistsOnActiveLayer(salleName)) {
    updateTooltipsVisibility();
    updateMarkersVisibility();
    return;
  }

  // Basculement du calque visible
  if (floor === "0") {
    if (!map.hasLayer(etage0)) {
      map.addLayer(etage0);
    }
    if (map.hasLayer(etage1)) {
      map.removeLayer(etage1);
    }
    if (map.hasLayer(etage2)) {
      map.removeLayer(etage2);
    }
  } else if (floor === "1") {
    if (!map.hasLayer(etage1)) {
      map.addLayer(etage1);
    }
    if (map.hasLayer(etage0)) {
      map.removeLayer(etage0);
    }
    if (map.hasLayer(etage2)) {
      map.removeLayer(etage2);
    }
  } else if (floor === "2") {
    if (!map.hasLayer(etage2)) {
      map.addLayer(etage2);
    }
    if (map.hasLayer(etage0)) {
      map.removeLayer(etage0);
    }
    if (map.hasLayer(etage1)) {
      map.removeLayer(etage1);
    }
  }

  // Assurez-vous que les flèches sont ajoutées après les segments de l'itinéraire
  updateTooltipsVisibility();
  updateMarkersVisibility();
  updateArrowsVisibility();
  updateButtonsVisibility();
}

      var StartIcon = L.icon({
        iconUrl: "images/starticon.png",

        iconSize: [15, 15], // size of the icon
        iconAnchor: [7.5, 7.5], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -10], // point from which the popup should open relative to the iconAnchor
        pane: "markerPane", // Ensure the icon is added to the markerPane
      });

      var EndIcon = L.icon({
        iconUrl: "images/endicon.png",

        iconSize: [15, 15], // size of the icon
        iconAnchor: [7.5, 7.5], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -10], // point from which the popup should open relative to the iconAnchor
        pane: "markerPane", // Ensure the icon is added to the markerPane
      });

      // --- 10. Variables pour la gestion des marqueurs de départ et d'arrivée ---
      var startPoint = null;
      var endPoint = null;

      // --- 11. Fonctions de surlignage (pour les recherches) ---
      function highlightFeature(layer) {
        layer.setStyle({ weight: 3, fillOpacity: 0.97 });
        layer.bringToFront();
      }
      // Modified resetHighlight function - REPLACE THIS SECTION
      function resetHighlight() {
        [salleLayer0, salleLayer1, salleLayer2].forEach(function (layerGroup) {
          layerGroup.eachLayer(function (layer) {
            layerGroup.resetStyle(layer);
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        });
      }

      // --- 12. Vérification et calcul de l'itinéraire ---
      function checkAndCalculateRoute() {
        if (startPoint && endPoint) {
          var startCoords = [
            startPoint.getLatLng().lat,
            startPoint.getLatLng().lng,
          ];
          var endCoords = [endPoint.getLatLng().lat, endPoint.getLatLng().lng];
          getRouteAndPoints(startCoords, endCoords);
        }
      }

      // --- 13. Barre de recherche pour le marqueur de départ ---
      var searchGroup = L.featureGroup();
      salleLayer0.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });
      salleLayer1.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });
      // Après avoir ajouté salleLayer0 et salleLayer1 à searchGroup
      salleLayer2.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });

      var searchControlStart = new L.Control.Search({
        layer: searchGroup,
        propertyName: "name",
        marker: false,
        collapsed: false,
        moveToLocation: function (latlng, title, map) {
          // Laisser le zoom personnalisé se gérer ailleurs
        },
        position: "topleft",
        textPlaceholder: "Point de départ",
      });
      map.addControl(searchControlStart);
      // Ajout de l'id au container du contrôle start
      searchControlStart.getContainer().id = "search-control-start";
      // Lorsqu'une recherche est ouverte, ajouter un id au tooltip
      searchControlStart.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-start";
        }
      });

      searchControlStart.on("search:locationfound", function (e) {
        resetHighlight();
        if (startPoint) {
          map.removeLayer(startPoint);
          startPoint = null;
        }
        var salleFeature = e.layer;
        var salleName = salleFeature.feature.properties.name || salleFeature.feature.properties.salle;
        switchFloor(salleFeature.feature.properties.floor, salleName);
        var key = salleName;
        var matchingFeatures = [];
        var activeLayer = map.hasLayer(etage0) ? salleLayer0 : map.hasLayer(etage1) ? salleLayer1 : salleLayer2;
        activeLayer.eachLayer(function (layer) {
          var layerKey = layer.feature.properties.name || layer.feature.properties.salle;
          if (layerKey === key) {
            matchingFeatures.push(layer);
          }
        });
        if (matchingFeatures.length > 0) {
          var group = new L.featureGroup(matchingFeatures);
          map.fitBounds(group.getBounds());
          matchingFeatures.forEach(function (layer) {
            highlightFeature(layer);
          });
          var cheminFeature = null;
          var floor = salleFeature.feature.properties.floor;
          var cheminLayer =
            floor === "0"
              ? CheminEtageLayer0
              : floor === "1"
              ? CheminEtageLayer1
              : CheminEtageLayer2;
          cheminLayer.eachLayer(function (layer) {
            var layerKey =
              layer.feature.properties.name || layer.feature.properties.salle;
            if (layer.feature && layerKey === key) {
              cheminFeature = layer;
            }
          });
          if (cheminFeature) {
            var center = cheminFeature.getBounds().getCenter();
            startPoint = L.marker(center, { icon: StartIcon, floor: floor })
              .addTo(map)
              .bindPopup("Point de départ sur le chemin de " + key, {
                autoPan: false,
              })
              .openPopup();
          }
        }
        updateMarkersVisibility();
        checkAndCalculateRoute();
      });

      // --- 14. Barre de recherche pour le marqueur de fin ---
      var searchControlEnd = new L.Control.Search({
        layer: searchGroup,
        propertyName: "name",
        marker: false,
        collapsed: false,
        moveToLocation: function (latlng, title, map) {
          // Pas d'action ici
        },
        position: "topleft",
        textPlaceholder: "Point d'arrivée",
      });
      map.addControl(searchControlEnd);
      // Ajout de l'id au container du contrôle end
      searchControlEnd.getContainer().id = "search-control-end";
      // Lorsqu'une recherche est ouverte, ajouter un id au tooltip
      searchControlEnd.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-end";
        }
      });

      searchControlEnd.on("search:locationfound", function (e) {
        resetHighlight();
        if (endPoint) {
          map.removeLayer(endPoint);
          endPoint = null;
        }
        var salleFeature = e.layer;
        var salleName = salleFeature.feature.properties.name || salleFeature.feature.properties.salle;
        switchFloor(salleFeature.feature.properties.floor, salleName);
        var key = salleName;
        var matchingFeatures = [];
        var activeLayer = map.hasLayer(etage0) ? salleLayer0 : map.hasLayer(etage1) ? salleLayer1 : salleLayer2;
        activeLayer.eachLayer(function (layer) {
          var layerKey =
            layer.feature.properties.name || layer.feature.properties.salle;
          if (layerKey === key) {
            matchingFeatures.push(layer);
          }
        });
        if (matchingFeatures.length > 0) {
          var group = new L.featureGroup(matchingFeatures);
          map.fitBounds(group.getBounds());
          matchingFeatures.forEach(function (layer) {
            highlightFeature(layer);
          });
          var cheminFeature = null;
          var floor = salleFeature.feature.properties.floor;
          var cheminLayer =
            floor === "0"
              ? CheminEtageLayer0
              : floor === "1"
              ? CheminEtageLayer1
              : CheminEtageLayer2;
          cheminLayer.eachLayer(function (layer) {
            var layerKey =
              layer.feature.properties.name || layer.feature.properties.salle;
            if (layer.feature && layerKey === key) {
              cheminFeature = layer;
            }
          });
          if (cheminFeature) {
            var center = cheminFeature.getBounds().getCenter();
            endPoint = L.marker(center, { icon: EndIcon, floor: floor })
              .addTo(map)
              .bindPopup("Point de fin sur le chemin de " + key, {
                autoPan: false,
              })
              .openPopup();
          }
        }
        updateMarkersVisibility();
        checkAndCalculateRoute();
      });

      searchControlStart.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-start";
          this._tooltip.classList.add("search-tooltip-start"); // Ajoute une classe spécifique
          console.log(
            "ID de la tooltip de recherche de départ :",
            this._tooltip.id
          );
        }
      });

      searchControlEnd.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-end";
          this._tooltip.classList.add("search-tooltip-end"); // Ajoute une classe spécifique
          console.log(
            "ID de la tooltip de recherche de fin :",
            this._tooltip.id
          );
        }
      });

      function getRouteAndPoints(start, end) {
        var osrmUrl = `https://classefinder.duckdns.org/osrm/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?steps=true&geometries=geojson&overview=full`;

        fetch(osrmUrl)
          .then((response) => response.json())
          .then((data) => {
            if (data.routes && data.routes.length > 0) {
              var route = data.routes[0];

              itinéraireLayer0.clearLayers();
              itinéraireLayer1.clearLayers();
              itinéraireLayer2.clearLayers();

              route.legs[0].steps.forEach((step, index) => {
                var startName = step.name || "";
                var segment = {
                  type: "Feature",
                  geometry: {
                    type: "LineString",
                    coordinates: step.geometry.coordinates,
                  },
                  properties: { name: startName },
                };

                var color = "#0031D2";
                var itineraireLayer = itinéraireLayer0;
                if (startName.toLowerCase().includes("1")) {
                  color = "#3564FF";
                  itineraireLayer = itinéraireLayer1;
                } else if (startName.toLowerCase().includes("2")) {
                  color = "#002499";
                  itineraireLayer = itinéraireLayer2;
                }

                var polyline = L.polyline(
                  step.geometry.coordinates.map((coord) => [
                    coord[1],
                    coord[0],
                  ]),
                  {
                    pane: "routePane", // Affecte le polyline au pane "routePane"
                    color: color,
                    weight: 10,
                  }
                );

                var polyline = L.polyline(
                  step.geometry.coordinates.map(coord => [coord[1], coord[0]]),
                  {
                    pane: "routePane",
                    color: color,
                    weight: 10,
                  }
                );

                var arrow = L.polylineDecorator(polyline, {
  pane: "arrowPane",
  patterns: [
    {
      offset: "9s",
      repeat: "50%",
      symbol: L.Symbol.arrowHead({
        pixelSize: 9,
        headAngle: 60,
        polygon: false,
        pathOptions: {
          pane: "arrowPane", // Ajouté ici
          stroke: true,
          color: "white",
          weight: 3,
          fill: false,
          fillOpacity: 1,
        },
      }),
    },
    {
      offset: "0%",
      repeat: "50%",
      symbol: L.Symbol.dash({
        pixelSize: 10,
        pathOptions: {
          pane: "arrowPane", // Ajouté ici
          stroke: true,
          color: "white",
          weight: 3,
          fill: false,
          fillOpacity: 1,
        },
      }),
    },
  ],
});
    itineraireLayer.addLayer(polyline).addLayer(arrow); // Ajoute les deux au groupe
              });

              var bounds = L.geoJSON(route.geometry).getBounds();
              map.fitBounds(bounds);

              updateArrowsVisibility();
            }
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la récupération de l'itinéraire:",
              error
            );
          });
      }

      // --- 16. Contrôle des calques via le sélecteur ---
      var baseLayers = {
        "Étage 1": etage1,
        "Étage 0": etage0,
        "Étage -1": etage2,
      };
      L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

      // Listen for layer changes and update tooltips
      map.on("baselayerchange", function (e) {
        updateTooltipsVisibility();
        updateMarkersVisibility();
        updateArrowsVisibility();
      });


      map.removeLayer(etage1);

      function updateMarkersVisibility() {
        if (map.hasLayer(etage0)) {
          if (startPoint && startPoint.options.floor !== "0") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "0") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "0") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "0") {
            map.addLayer(endPoint);
          }
        } else if (map.hasLayer(etage1)) {
          if (startPoint && startPoint.options.floor !== "1") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "1") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "1") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "1") {
            map.addLayer(endPoint);
          }
        } else if (map.hasLayer(etage2)) {
          if (startPoint && startPoint.options.floor !== "2") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "2") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "2") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "2") {
            map.addLayer(endPoint);
          }
        }
      }

      // Fonction de cycle des calques au démarrage
      function cycleLayers() {
        // Afficher étage 0 immédiatement
        switchFloor("0");
        // Après 3 secondes, afficher étage 1
        setTimeout(function () {
          switchFloor("1");
          // Après 3 secondes supplémentaires, afficher étage 2
          setTimeout(function () {
            switchFloor("2");
            setTimeout(function () {
              switchFloor("0");
            }, 1);
          }, 1);
        }, 1);
      }

      // Appeler la fonction lors du chargement du site
      cycleLayers();
    </script>
  </body>
</html>