<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Carte Leaflet avec Maplibre GL Basemap, Géofencing et Mode Sombre
    </title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.css"
    />
    <style>
      body {
        margin: 0;
      }
      #map {
        height: 100vh;
        width: 100%;
        display: block;
      }

      .custom-controls-wrapper {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        border: 1px solid gray;
        border-radius: 10px;
        padding: 0px;
        z-index: 1000;
        width: 103px;
        height: auto;
        display: flex;
        flex-direction: column;
        gap: 0px;
      }

      /* Remove default backgrounds/borders */
      .leaflet-control-locate a,
      .leaflet-control-layers {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
      }

      /* Separators */
      .separator {
        height: 1px;
        background: gray;
        width: 100%;
        margin: 0px 0;
      }
      .sep-vertical {
        width: 1px;
        background: gray;
        height: 24px;
        align-self: center;
      }

      .button-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0px;
      }

      .button-row > * {
        flex: 1;
      }
      .sep-vertical {
        flex: none;
        width: 1px;
        background: gray;
        height: 24px;
        align-self: center;
      }

      .theme-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
      }

      .theme-toggle img {
        width: 32px; /* Adjust width */
        height: 32px; /* Adjust height */
      }

      /* Font size for control layer */
      .leaflet-control-layers {
        font-size: 10px; /* Adjust font size as needed */
      }

      /* Adjustable size for locate control button */
      .leaflet-control-locate {
        width: 50px; /* Adjust width */
        height: 38px; /* Adjust height */
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="custom-controls-wrapper">
      <!-- Layer control -->
      <div id="leaflet-control-container" class="leaflet-control-layers"></div>
      <div class="separator"></div>

      <!-- Bottom buttons -->
      <div class="button-row">
        <div id="locate-placeholder" class="leaflet-control-locate"></div>
        <div class="sep-vertical"></div>
        <button id="themeToggle" class="theme-toggle">
          <img
            id="themeIcon"
            src="https://cdn-icons-png.flaticon.com/512/1164/1164954.png"
            alt="Toggle Theme"
          />
        </button>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.20/leaflet-maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
      const lightStyle =
        "https://api.maptiler.com/maps/3b544fc3-420c-4a93-a594-a99b71d941bb/style.json?key=BiyHHi8FTQZ233ADqskZ";
      const darkStyle =
        "https://api.maptiler.com/maps/04c03a5d-804b-4c6f-9736-b7103fdb530b/style.json?key=BiyHHi8FTQZ233ADqskZ";
      let currentStyle = window.matchMedia("(prefers-color-scheme: dark)")
        .matches
        ? darkStyle
        : lightStyle;

      const map = L.map("map").setView([48.8566, 2.3522], 13);
      let glLayer = L.maplibreGL({ style: currentStyle }).addTo(map);

      const perimeterCenter = L.latLng(48.8566, 2.3522);
      const perimeterRadius = 10000000;
      const perimeterCircle = L.circle(perimeterCenter, {
        radius: perimeterRadius,
        color: "red",
        fillOpacity: 0.1,
      });

      let processed = false;
      function onlyBaseMapWithNotice(msg) {
        if (!processed) {
          processed = true;
          perimeterCircle.addTo(map);
          map.setView(perimeterCenter, 13);
          L.popup({ closeOnClick: false, autoClose: false })
            .setLatLng(perimeterCenter)
            .setContent(msg)
            .openOn(map);
        }
      }
      function onOutOfZone(latlng) {
        if (!processed) {
          processed = true;
          perimeterCircle.addTo(map);
          const bounds = L.latLngBounds([latlng, perimeterCenter]);
          map.fitBounds(bounds.pad(0.25));
          L.popup()
            .setLatLng(latlng)
            .setContent("Vous êtes hors de la zone autorisée.")
            .openOn(map);
        }
      }
      function onAuthorizedZoneAccess(latlng) {
        if (!processed) {
          processed = true;
          console.log("Accès autorisé : utilisateur dans la zone.");
          if (map.hasLayer(perimeterCircle)) map.removeLayer(perimeterCircle);
          const marker = L.marker(latlng).bindPopup("Bienvenue !");
          const overlay = L.layerGroup([marker]);
          const overlays = [
            L.marker([48.857, 2.353]).bindPopup("Etage 1"),
            L.marker([48.858, 2.354]).bindPopup("Etage 2"),
          ];
          const layerControl = L.control.layers(
            { "Etage 0": glLayer },
            { "Etage 1": overlay },
            { collapsed: false }
          );
          layerControl.addTo(map);
          const leafletControl = document.querySelector(
            ".leaflet-control-layers"
          );
          const controlContainer = document.getElementById(
            "leaflet-control-container"
          );
          if (leafletControl && controlContainer) {
            controlContainer.appendChild(leafletControl);
            leafletControl.style.display = "block";
          }
          overlay.addTo(map);
        }
      }

      const locateControl = L.control
        .locate({
          drawCircle: true,
          showPopup: false,
          keepCurrentZoomLevel: true,
          flyTo: true,
          cacheLocation: true,
          watch: false,
          locateOptions: {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000,
          },
        })
        .addTo(map);
      map.on("locationerror", () =>
        onlyBaseMapWithNotice(
          "Localisation requise pour accéder au contenu complet."
        )
      );
      map.on("locationfound", (e) => {
        const latlng = e.latlng;
        const distance = latlng.distanceTo(perimeterCenter);
        if (distance <= perimeterRadius) onAuthorizedZoneAccess(latlng);
        else onOutOfZone(latlng);
      });
      locateControl.start();

      // Déplacer le bouton de localisation
      const locateBtn = document.querySelector(".leaflet-control-locate");
      const locatePlaceholder = document.getElementById("locate-placeholder");
      if (locateBtn && locatePlaceholder) {
        locatePlaceholder.appendChild(locateBtn);
        locateBtn.style.display = "block";
        locateBtn.style.zIndex = 1001;
      }

      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      themeToggle.addEventListener("click", () => {
        const isDark = currentStyle === darkStyle;
        currentStyle = isDark ? lightStyle : darkStyle;
        themeIcon.src = isDark
          ? "https://cdn-icons-png.flaticon.com/512/1164/1164954.png"
          : "https://cdn-icons-png.flaticon.com/512/1164/1164950.png";
        map.removeLayer(glLayer);
        glLayer = L.maplibreGL({ style: currentStyle });
        map.addLayer(glLayer);
      });
    </script>
  </body>
</html>
