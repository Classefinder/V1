<!DOCTYPE html>
<html>
<head>
  <title>Carte Leaflet Simple</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.css" />

  <style>
    #map { height: 100vh; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.js"></script>

  <script>
    // Fonds de carte
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' });
    const carto = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' });

    // Carte
    const map = L.map('map', { center: [48.8566, 2.3522], zoom: 13, layers: [osm] });

    // Périmètre
    const perimeterCenter = L.latLng(48.8566, 2.3522);
    const perimeterRadius = 10000; // en mètres
    const perimeterCircle = L.circle(perimeterCenter, { radius: perimeterRadius, color: 'red', fillOpacity: 0.1 });

    // Flags pour éviter les appels répétés
    let processed = false;

    // Fonctions de gestion
    function onlyBaseMapWithNotice(message) {
      perimeterCircle.addTo(map);
      map.setView(perimeterCenter, 13);
      L.popup({ closeOnClick: false, autoClose: false })
        .setLatLng(perimeterCenter)
        .setContent(message)
        .openOn(map);
    }

    function onOutOfZone(latlng) {
      if (processed) return;
      processed = true;
      perimeterCircle.addTo(map);
      const bounds = L.latLngBounds([latlng, perimeterCenter]);
      map.fitBounds(bounds.pad(0.25));
      L.popup()
        .setLatLng(latlng)
        .setContent('Vous êtes hors de la zone autorisée.')
        .openOn(map);
    }

    function onAuthorizedZoneAccess() {
      if (processed) return;
      processed = true;
      console.log('Accès autorisé : utilisateur dans la zone.');
      const marker = L.marker(perimeterCenter).bindPopup('Paris');
      const overlay = L.layerGroup([marker]);
      L.control.layers({ 'OSM': osm, 'Carto Light': carto }, { 'Marqueur Paris': overlay }).addTo(map);
      overlay.addTo(map);
    }

    // Contrôle de localisation
    const locateControl = L.control.locate({
      drawCircle: false,
      showPopup: false,
      keepCurrentZoomLevel: true,
      flyTo: true,
      cacheLocation: true,
      watch: true,
      locateOptions: { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
    }).addTo(map);

    // Événements
    map.on('locationerror', function() {
      if (processed) return;
      processed = true;
      onlyBaseMapWithNotice('Localisation requise pour accéder au contenu complet.');
    });

    map.on('locationfound', function(e) {
      if (processed) return;
      const userLatLng = e.latlng;
      const distance = userLatLng.distanceTo(perimeterCenter);
      if (distance <= perimeterRadius) {
        if (map.hasLayer(perimeterCircle)) map.removeLayer(perimeterCircle);
        onAuthorizedZoneAccess();
      } else {
        onOutOfZone(userLatLng);
      }
    });

    // Démarrage : déclenche la géolocalisation via le plugin (une seule fois)
    locateControl.start();
  </script>
</body>
</html>
