<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte Leaflet avec GeoJSON et Mode Sombre</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
      }

      #map {
        height: 100vh;
        width: 100%;
        display: block;
      }

      /* Conteneur principal des contrôles */
      .custom-controls-wrapper {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        border: 2px solid #ccc;
        border-radius: 15px;
        padding: 0;
        z-index: 1000;
        width: 110px;
        height: 124px;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Contrôle des couches */
      #leaflet-control-container {
        padding: 0px;
        box-sizing: border-box;
      }

      .leaflet-control-layers {
        box-shadow: none !important;
      }

      .leaflet-control-layers-expanded {
        width: 100% !important;
        padding: 7px !important;
        padding-right: 5px !important;
        box-shadow: none !important;
        background: transparent !important;
        border: none !important;
      }

      .leaflet-control-layers label {
        margin: 2px 0;
        display: block;
        width: 100%;
      }

      /* Séparateurs */
      .separator {
        height: 2px;
        background: #e0e0e0;
        width: 100%;
        margin: 0;
      }

      .sep-vertical {
        width: 2px !important;
        background: #e0e0e0;
        height: 32px;
        margin: 0;
        padding: 0;
        flex: 0 0 2px;
      }

      /* Ligne des boutons */
      .button-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0;
        padding: 0px 0px;
        width: 100%;
        box-sizing: border-box;
      }

      .leaflet-control-locate a {
        width: 51px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: none !important;
        border: none !important;
        box-shadow: none !important;
      }

      .leaflet-control-locate {
        background: none !important;
        border: none !important;
        box-shadow: none !important;
      }

      .leaflet-control-locate:hover {
        background-color: #f0f0f0 !important;
      }

      /* Bouton de thème */
      .theme-toggle {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        width: 57px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 0px;
        transition: background-color 0.2s;
      }

      .theme-toggle:hover {
        background-color: #f0f0f0;
      }

      .theme-toggle img {
        width: 24px;
        height: 24px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="custom-controls-wrapper">
      <div id="leaflet-control-container" class="leaflet-control-layers"></div>
      <div class="separator"></div>
      <div class="button-row">
        <div id="locate-placeholder" class="leaflet-control-locate"></div>
        <div class="sep-vertical"></div>
        <button id="themeToggle" class="theme-toggle">
          <img
            id="themeIcon"
            src="https://cdn-icons-png.flaticon.com/512/1164/1164954.png"
            alt="Toggle Theme"
          />
        </button>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol@0.81.0/dist/L.Control.Locate.min.js"></script>
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.0.20/leaflet-maplibre-gl.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
      // Styles de base
      const lightStyle =
        "https://api.maptiler.com/maps/3b544fc3-420c-4a93-a594-a99b71d941bb/style.json?key=BiyHHi8FTQZ233ADqskZ";
      const darkStyle =
        "https://api.maptiler.com/maps/04c03a5d-804b-4c6f-9736-b7103fdb530b/style.json?key=BiyHHi8FTQZ233ADqskZ";
      let currentStyle = window.matchMedia("(prefers-color-scheme: dark)")
        .matches
        ? darkStyle
        : lightStyle;

      // Initialisation de la carte
      const map = L.map("map", {
        preferCanvas: true,
      }).setView([48.8566, 2.3522], 13);

      let glLayer = L.maplibreGL({
        style: currentStyle,
        pane: "mapPane",
      }).addTo(map);

      // Variables pour la gestion de la zone
      const perimeterCenter = L.latLng(48.8566, 2.3522);
      const perimeterRadius = 10000000;
      const perimeterCircle = L.circle(perimeterCenter, {
        radius: perimeterRadius,
        color: "red",
        fillOpacity: 0.1,
      });

      // Fonction pour créer des couches GeoJSON (exemple avec des données inline)
      function createGeoJSONLayers() {
        // Exemple de données GeoJSON pour chaque étage
        const etageMinus1 = {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              properties: {},
              geometry: {
                coordinates: [
                  [
                    [2.34, 48.84],
                    [2.36, 48.84],
                    [2.36, 48.86],
                    [2.34, 48.86],
                    [2.34, 48.84],
                  ],
                ],
                type: "Polygon",
              },
            },
          ],
        };

        const etage0 = {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              properties: {},
              geometry: {
                coordinates: [
                  [
                    [2.35, 48.85],
                    [2.37, 48.85],
                    [2.37, 48.87],
                    [2.35, 48.87],
                    [2.35, 48.85],
                  ],
                ],
                type: "Polygon",
              },
            },
          ],
        };

        const etage1 = {
          type: "FeatureCollection",
          features: [
            {
              type: "Feature",
              properties: {},
              geometry: {
                coordinates: [
                  [
                    [2.33, 48.83],
                    [2.35, 48.83],
                    [2.35, 48.85],
                    [2.33, 48.85],
                    [2.33, 48.83],
                  ],
                ],
                type: "Polygon",
              },
            },
          ],
        };

        // Création des couches Leaflet
        const layerMinus1 = L.geoJSON(etageMinus1, {
          style: {
            fillColor: "blue",
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: "3",
            fillOpacity: 0.7,
          },
          pane: "overlayPane",
        });

        const layer0 = L.geoJSON(etage0, {
          style: {
            fillColor: "green",
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: "3",
            fillOpacity: 0.7,
          },
          pane: "overlayPane",
        });

        const layer1 = L.geoJSON(etage1, {
          style: {
            fillColor: "red",
            weight: 2,
            opacity: 1,
            color: "white",
            dashArray: "3",
            fillOpacity: 0.7,
          },
          pane: "overlayPane",
        });

        return {
          layerMinus1,
          layer0,
          layer1,
        };
      }

      let processed = false;
      function onlyBaseMapWithNotice(msg) {
        if (!processed) {
          processed = true;
          perimeterCircle.addTo(map);
          map.setView(perimeterCenter, 13);
          L.popup({ closeOnClick: false, autoClose: false })
            .setLatLng(perimeterCenter)
            .setContent(msg)
            .openOn(map);
        }
      }

      function onOutOfZone(latlng) {
        if (!processed) {
          processed = true;
          perimeterCircle.addTo(map);
          const bounds = L.latLngBounds([latlng, perimeterCenter]);
          map.fitBounds(bounds.pad(0.25));
          L.popup()
            .setLatLng(latlng)
            .setContent("Vous êtes hors de la zone autorisée.")
            .openOn(map);
        }
      }

      function onAuthorizedZoneAccess(latlng) {
        if (!processed) {
          processed = true;
          console.log("Accès autorisé : utilisateur dans la zone.");
          if (map.hasLayer(perimeterCircle)) map.removeLayer(perimeterCircle);

          const marker = L.marker(latlng).bindPopup("Bienvenue !");
          marker.addTo(map);

          // Création des couches GeoJSON
          const { layerMinus1, layer0, layer1 } = createGeoJSONLayers();

          // Ajout du contrôle des couches
          const layerControl = L.control.layers(
            {
              "Etage -1": layerMinus1,
              "Etage 0": layer0,
              "Etage 1": layer1,
            },
            null,
            {
              collapsed: false,
              position: "topright",
            }
          );

          layerControl.addTo(map);
          layerMinus1.addTo(map); // Ajouter la première couche par défaut

          // Déplacer le contrôle des couches dans notre conteneur personnalisé
          const leafletControl = document.querySelector(
            ".leaflet-control-layers"
          );
          const controlContainer = document.getElementById(
            "leaflet-control-container"
          );
          if (leafletControl && controlContainer) {
            controlContainer.appendChild(leafletControl);
            leafletControl.style.display = "block";
          }
        }
      }

      // Contrôle de localisation
      const locateControl = L.control
        .locate({
          drawCircle: true,
          showPopup: false,
          keepCurrentZoomLevel: true,
          flyTo: true,
          cacheLocation: true,
          watch: false,
          locateOptions: {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000,
          },
        })
        .addTo(map);

      map.on("locationerror", () =>
        onlyBaseMapWithNotice(
          "Localisation requise pour accéder au contenu complet."
        )
      );

      map.on("locationfound", (e) => {
        const latlng = e.latlng;
        const distance = latlng.distanceTo(perimeterCenter);
        if (distance <= perimeterRadius) onAuthorizedZoneAccess(latlng);
        else onOutOfZone(latlng);
      });

      locateControl.start();

      // Déplacer le bouton de localisation
      const locateBtn = document.querySelector(".leaflet-control-locate");
      const locatePlaceholder = document.getElementById("locate-placeholder");
      if (locateBtn && locatePlaceholder) {
        locatePlaceholder.appendChild(locateBtn);
        locateBtn.style.display = "flex";
      }

      // Gestion du thème
      const themeToggle = document.getElementById("themeToggle");
      const themeIcon = document.getElementById("themeIcon");
      themeToggle.addEventListener("click", () => {
        const isDark = currentStyle === darkStyle;
        currentStyle = isDark ? lightStyle : darkStyle;
        themeIcon.src = isDark
          ? "https://cdn-icons-png.flaticon.com/512/1164/1164954.png"
          : "https://cdn-icons-png.flaticon.com/512/1164/1164950.png";
        map.removeLayer(glLayer);
        glLayer = L.maplibreGL({
          style: currentStyle,
          pane: "mapPane",
        });
        map.addLayer(glLayer);
      });
    </script>
  </body>
</html>
