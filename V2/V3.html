<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Carte Leaflet Thème Clair/Sombre</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Locate Control CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"
    />
    <style>
      :root {
        --bg-color: #ffffff;
        --text-color: #000000;
      }
      [data-theme="dark"] {
        --bg-color: #181818;
        --text-color: #ffffff;
      }
      body {
        margin: 0;
        padding: 0;
        background: var(--bg-color);
        color: var(--text-color);
        height: 100vh;
        overflow: hidden;
        position: relative;
      }
      #map {
        width: 100%;
        height: 100%;
        display: none; /* cachée tant que géoloc non autorisée */
      }
      #message {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--bg-color);
        color: var(--text-color);
        padding: 1rem;
        border-radius: 0.5rem;
        text-align: center;
        display: none;
      }
      #theme-toggle {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        cursor: pointer;
        z-index: 1000;
      }
      #theme-toggle svg {
        width: 32px;
        height: 32px;
        fill: var(--text-color);
      }
    </style>
  </head>
  <body>
    <button id="theme-toggle" aria-label="Basculer thème">
      <!-- Icône illustrative (soleil/lune) -->
      <svg viewBox="0 0 24 24">
        <path
          d="M12 4.354a7.646 7.646 0 1 0 7.646 7.646A7.655 7.655 0 0 0 12 4.354zm0-2a9.646 9.646 0 1 1-9.646 9.646A9.657 9.657 0 0 1 12 2.354z"
        />
      </svg>
    </button>

    <div id="map"></div>
    <div id="message">
      La localisation est nécessaire pour afficher le site.
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
    <script src="https://unpkg.com/leaflet-maplibre-gl/Leaflet.MapLibreGL.js"></script>
    <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
    <script>
      // Configuration de périmètre
      const perimeterCenter = [48.8566, 2.3522]; // exemple: Paris
      const perimeterRadius = 5000; // en mètres

      // Fonctions de gestion
      function handleDenied() {
        document.getElementById("message").style.display = "block";
      }

      function handleOutside(position, map, perimeterCircle) {
        map.getContainer().style.display = "block";
        perimeterCircle.addTo(map);
        map.setView(position, 13);
      }

      function handleInside(position, map) {
        map.getContainer().style.display = "block";
        map.setView(position, 13);
        // Exécutez ici le contenu de votre site à l'intérieur de la zone
        onInsideZone();
      }

      function onInsideZone() {
        console.log(
          "Utilisateur à l’intérieur du périmètre: ici vous ajoutez votre contenu."
        );
      }

      // Initialisation de la carte
      let map, glLayer, locateControl, perimeterCircle;
      function initMap(position) {
        map = L.map("map", { zoomControl: false });
        // couche vectorielle MapLibre
        const styleLight = "https://demotiles.maplibre.org/style.json";
        const styleDark = "https://demotiles.maplibre.org/style.json"; // remplacer par style sombre
        const initialStyle =
          document.body.getAttribute("data-theme") === "dark"
            ? styleDark
            : styleLight;
        glLayer = L.maplibreGL({ style: initialStyle }).addTo(map);

        // Locate Control
        locateControl = L.control
          .locate({
            showPopup: false,
            flyTo: false,
            keepCurrentZoomLevel: true,
            markerStyle: {
              weight: 2,
              opacity: 1,
              fillOpacity: 1,
              fillColor: "#3388ff",
              color: "#fff",
            },
          })
          .addTo(map);

        // Cercle de périmètre
        perimeterCircle = L.circle(perimeterCenter, {
          radius: perimeterRadius,
          color: "red",
        });

        // Calques vectoriels (exemple geojson)
        const floor1 = L.geoJSON(/* vos données GeoJSON étage 1 */);
        const floor2 = L.geoJSON(/* vos données GeoJSON étage 2 */);
        const baseLayers = { "Étage 1": floor1, "Étage 2": floor2 };
        L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

        // Demande de géolocalisation
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const userPos = [pos.coords.latitude, pos.coords.longitude];
            const distance = map.distance(userPos, perimeterCenter);
            if (distance <= perimeterRadius) {
              handleInside(userPos, map);
            } else {
              handleOutside(userPos, map, perimeterCircle);
            }
            // afficher marqueur
            locateControl.start();
          },
          (err) => handleDenied(),
          { enableHighAccuracy: true }
        );
      }

      // Thème
      const toggle = document.getElementById("theme-toggle");
      const media = window.matchMedia("(prefers-color-scheme: dark)");
      function applyTheme(dark) {
        document.body.setAttribute("data-theme", dark ? "dark" : "light");
        if (glLayer && glLayer._glMap) {
          const newStyle = dark ? styleDark : styleLight;
          glLayer._glMap.setStyle(newStyle);
        }
      }
      media.addListener((e) => applyTheme(e.matches));
      toggle.addEventListener("click", () =>
        applyTheme(document.body.getAttribute("data-theme") !== "dark")
      );

      // Initialisation du thème puis carte
      applyTheme(media.matches);
      initMap();
    </script>
  </body>
</html>
