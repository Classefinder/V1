<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Classefinder | Lyc√©e Lachenal changement</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- MapLibre GL JS -->
    <link
      href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
    <!-- MapLibre GL Leaflet Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/@maplibre/maplibre-gl-leaflet@0.0.22/leaflet-maplibre-gl.js"></script>

    <!-- Leaflet Plugins -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.css"
    />

    <link rel="stylesheet" href="LyceeLachenal.css" />
    <script src="https://unpkg.com/leaflet-search@4.0.0/dist/leaflet-search.min.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
      #map {
        height: 100vh;
      }
      .room-label {
        font-weight: bold;
        color: black;
        background: rgba(255, 255, 255, 0.7);
        border: 1px solid gray;
        border-radius: 3px;
        padding: 2px 4px;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <button id="dark-mode-toggle">üåô</button>

    <script>
      // --- 1. Initialisation des limites ---
      var sudOuest = L.latLng(45.93818505744445, 6.134245788738398);
      var nordEst = L.latLng(45.93640970079779, 6.13115811037474);
      var limites = L.latLngBounds(sudOuest, nordEst);

      // --- 2. Cr√©ation de la carte ---
      var map = L.map("map", {
        center: [45.9368, 6.1322],
        zoom: 18,
        minZoom: 1,
        maxZoom: 23,
        maxBounds: limites,
        maxBoundsViscosity: 1.0,
      });

      // --- 3. Tuiles vectorielles MapTiler ---
      // Calque clair
      var lightMap = L.maplibreGL({
        style:
          "https://api.maptiler.com/maps/3b544fc3-420c-4a93-a594-a99b71d941bb/style.json?key=BiyHHi8FTQZ233ADqskZ",
        attribution:
          '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a> contributors',
      });

      // Calque sombre
      var darkMap = L.maplibreGL({
        style:
          "https://api.maptiler.com/maps/04c03a5d-804b-4c6f-9736-b7103fdb530b/style.json?key=BiyHHi8FTQZ233ADqskZ",
        attribution:
          '&copy; <a href="https://www.maptiler.com/copyright/" target="_blank">MapTiler</a> contributors',
      });

      // --- 4. Ajout du fond clair par d√©faut ---
      lightMap.addTo(map);

      // --- 2. Donn√©es GeoJSON pour les salles et les chemins ---
      var salleEtage0 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { name: "13" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132443855592967, 45.936792791783532],
                    [6.132451800410498, 45.936862076107261],
                    [6.132332645198166, 45.936867696926917],
                    [6.132323764318674, 45.936798784599809],
                    [6.132443855592967, 45.936792791783532],
                  ],
                ],
              ],
            },
          },
          {
            type: "Feature",
            properties: { name: "14" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132323764318674, 45.93679878003244],
                    [6.132332645193752, 45.936867696937178],
                    [6.132169440848435, 45.936875476859768],
                    [6.132160492656691, 45.936806544549889],
                    [6.132323764318674, 45.93679878003244],
                  ],
                ],
              ],
            },
          },
        ],
      };

      var salleEtage1 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { name: "117" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132443855592967, 45.936792791783532],
                    [6.132451800410498, 45.936862076107261],
                    [6.132332645198166, 45.936867696926917],
                    [6.132323764318674, 45.936798784599809],
                    [6.132443855592967, 45.936792791783532],
                  ],
                ],
              ],
            },
          },
          {
            type: "Feature",
            properties: { name: "115" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132323764318674, 45.93679878003244],
                    [6.132332645193752, 45.936867696937178],
                    [6.132169440848435, 45.936875476859768],
                    [6.132160492656691, 45.936806544549889],
                    [6.132323764318674, 45.93679878003244],
                  ],
                ],
              ],
            },
          },
        ],
      };

      var salleEtage2 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { name: "V1" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132559263481, 45.937761742137447],
                    [6.132605358389325, 45.937758765489001],
                    [6.132614138371865, 45.937824175393722],
                    [6.132567165465287, 45.937827991605154],
                    [6.132559263481, 45.937761742137447],
                  ],
                ],
              ],
            },
          },
          {
            type: "Feature",
            properties: { name: "V2" },
            geometry: {
              type: "MultiPolygon",
              coordinates: [
                [
                  [
                    [6.132607553384967, 45.937773801378285],
                    [6.132725973399444, 45.93776700851511],
                    [6.132730253640932, 45.937817306212494],
                    [6.132614138371868, 45.937824175393722],
                    [6.132607553384967, 45.937773801378285],
                  ],
                ],
              ],
            },
          },
        ],
      };

      var CheminEtage0 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { name: "14", foot: "yes", highway: "footway" },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.13229, 45.93681],
                [6.13228, 45.93679],
              ],
            },
          },
          {
            type: "Feature",
            properties: { name: "13", foot: "yes", highway: "footway" },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.13242, 45.9368],
                [6.13242, 45.93678],
              ],
            },
          },
        ],
      };

      var CheminEtage1 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: { highway: "footway", foot: "yes", name: "115" },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.1322, 45.93681],
                [6.1322, 45.9368],
              ],
            },
          },
          {
            type: "Feature",
            properties: { highway: "footway", foot: "yes", name: "117" },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.13242, 45.93678],
                [6.13242, 45.9368],
              ],
            },
          },
        ],
      };

      var CheminEtage2 = {
        type: "FeatureCollection",
        features: [
          {
            type: "Feature",
            properties: {
              foot: "yes",
              name: "V1",
              highway: "footway",
              layer: "-2",
              tunnel: "yes",
            },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.13259, 45.93777],
                [6.13262, 45.93777],
              ],
            },
          },
          {
            type: "Feature",
            properties: {
              foot: "yes",
              name: "V2",
              highway: "footway",
              layer: "-2",
              tunnel: "yes",
            },
            geometry: {
              type: "LineString",
              coordinates: [
                [6.13272, 45.9378],
                [6.13268, 45.93775],
              ],
            },
          },
        ],
      };

      document
        .getElementById("dark-mode-toggle")
        .addEventListener("click", function () {
          document.body.classList.toggle("dark-mode");
          if (document.body.classList.contains("dark-mode")) {
            map.removeLayer(lightMap);
            map.addLayer(darkMap);
            this.textContent = "‚òÄÔ∏è";
          } else {
            map.removeLayer(darkMap);
            map.addLayer(lightMap);
            this.textContent = "üåô";
          }
        });

      // --- 3. Cr√©ation des couches GeoJSON pour les salles ---
      // On n'utilise plus bindTooltip ici afin d'√©viter que le label s'affiche automatiquement au survol.
      function onEachSalleFeature(feature, layer, floor) {
        feature.properties.floor = floor;
        // Pour l'√©tage 1, si la propri√©t√© "name" est absente, on la copie depuis "salle"
        if (
          floor === "1" &&
          !feature.properties.name &&
          feature.properties.salle
        ) {
          feature.properties.name = feature.properties.salle;
        }
        layer.on({
          mouseover: function (e) {
            e.target.setStyle({
              color: "#6AB28F",
              weight: 3,
            });
          },
          mouseout: function (e) {
            if (floor === "0") {
              salleLayer0.resetStyle(e.target);
            } else if (floor === "1") {
              salleLayer1.resetStyle(e.target);
            } else if (floor === "2") {
              salleLayer2.resetStyle(e.target);
            }
          },
          click: function (e) {
            // Supprimer l'appel √† resetHighlight() pour conserver les labels
            // Zoom sur la feature cliqu√©e
            map.fitBounds(e.target.getBounds());
          },
        });
      }

      var salleLayer0 = L.geoJSON(salleEtage0, {
        style: function (feature) {
          return { color: "#81CAA7", weight: 2, fillOpacity: 0.8 };
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "0");
        },
      });

      var salleLayer1 = L.geoJSON(salleEtage1, {
        style: function (feature) {
          return { color: "#9EF3CA", weight: 2, fillOpacity: 0.8 };
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "1");
        },
      });

      var salleLayer2 = L.geoJSON(salleEtage2, {
        style: function (feature) {
          return { color: "#FF9999", weight: 2, fillOpacity: 0.8 }; // modifiez la couleur au besoin
        },
        onEachFeature: function (feature, layer) {
          onEachSalleFeature(feature, layer, "2");
        },
      });

      // --- 4. Calque des chemins ---
      //var CheminEtageLayer = L.geoJSON(CheminEtage, {
      // style: { color: 'transparent' }
      //});
      // CheminEtageLayer.addTo(map);

      var CheminEtageLayer0 = L.geoJSON(CheminEtage0, {
        style: { color: "transparent" },
      });

      var CheminEtageLayer1 = L.geoJSON(CheminEtage1, {
        style: { color: "transparent" },
      });

      var CheminEtageLayer2 = L.geoJSON(CheminEtage2, {
        style: { color: "transparent" },
      });

      // --- 5. Couches d'itin√©raire (initialement vides) ---
      var itin√©raireEtage0 = { type: "FeatureCollection", features: [] };
      var itin√©raireEtage1 = { type: "FeatureCollection", features: [] };
      var itin√©raireEtage2 = { type: "FeatureCollection", features: [] };

      var itin√©raireLayer0 = L.geoJSON(itin√©raireEtage0, {
        style: { color: "#3A5AC3", weight: 10 },
      });
      var itin√©raireLayer1 = L.geoJSON(itin√©raireEtage1, {
        style: { color: "#7898FF", weight: 10 },
      });
      var itin√©raireLayer2 = L.geoJSON(itin√©raireEtage2, {
        style: { color: "#FFA500", weight: 10 },
      });

      // --- 6. Fonds de carte personnalis√©s pour chaque groupe (en plus du fond par d√©faut) ---
      var customBackground0 = L.tileLayer(
        "../Donn√©es/QGIS/QTiles/etage0/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );
      var customBackground1 = L.tileLayer(
        "../Donn√©es/QGIS/QTiles/etage1/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );
      var customBackground2 = L.tileLayer(
        "../Donn√©es/QGIS/QTiles/etage2/{z}/{x}/{y}.png",
        {
          opacity: 1,
          maxZoom: 23,
        }
      );

      // --- 7. Groupes par √©tage en ajoutant le fond personnalis√© dans le groupe ---
      var etage0 = L.layerGroup([
        customBackground0,
        salleLayer0,
        itin√©raireLayer0,
        CheminEtageLayer0,
      ]);
      var etage1 = L.layerGroup([
        customBackground1,
        salleLayer1,
        itin√©raireLayer1,
        CheminEtageLayer1,
      ]);
      var etage2 = L.layerGroup([
        customBackground2,
        salleLayer2,
        itin√©raireLayer2,
        CheminEtageLayer2,
      ]);
      // Par d√©faut, le groupe de l'√©tage 0 est affich√©.
      etage0.addTo(map);

      // --- 8. Gestion des labels (tooltips) en fonction du niveau de zoom ---
      const tooltipZoomThreshold = 20; // Seuil de zoom pour afficher les labels
      const arrowZoomThreshold = 21; // Seuil de zoom pour afficher les fl√®ches

      function updateTooltipsVisibility() {
        var currentZoom = map.getZoom();

        function toggleTooltips(layerGroup) {
          layerGroup.eachLayer(function (layer) {
            if (currentZoom >= tooltipZoomThreshold) {
              if (!layer._customTooltip) {
                var labelContent =
                  layer.feature.properties.name ||
                  layer.feature.properties.salle;
                if (labelContent) {
                  var center = layer.getBounds().getCenter();
                  var tooltip = L.tooltip({
                    permanent: true,
                    direction: "center",
                    className: "room-label",
                  })
                    .setContent(labelContent)
                    .setLatLng(center);
                  tooltip.addTo(map);
                  layer._customTooltip = tooltip;
                }
              }
            } else if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 0
        if (map.hasLayer(etage0)) {
          toggleTooltips(salleLayer0);
        } else {
          salleLayer0.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 1
        if (map.hasLayer(etage1)) {
          toggleTooltips(salleLayer1);
        } else {
          salleLayer1.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        // Etage 2
        if (map.hasLayer(etage2)) {
          toggleTooltips(salleLayer2);
        } else {
          salleLayer2.eachLayer(function (layer) {
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        }

        updateArrowsVisibility();
      }

      function updateArrowsVisibility() {
        var currentZoom = map.getZoom();

        function toggleArrows(layerGroup) {
          layerGroup.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator) {
              if (currentZoom >= arrowZoomThreshold) {
                if (!map.hasLayer(layer)) {
                  map.addLayer(layer);
                }
              } else {
                if (map.hasLayer(layer)) {
                  map.removeLayer(layer);
                }
              }
            }
          });
        }

        if (map.hasLayer(etage0)) {
          toggleArrows(itin√©raireLayer0);
        } else {
          itin√©raireLayer0.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }

        if (map.hasLayer(etage1)) {
          toggleArrows(itin√©raireLayer1);
        } else {
          itin√©raireLayer1.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }

        if (map.hasLayer(etage2)) {
          toggleArrows(itin√©raireLayer2);
        } else {
          itin√©raireLayer2.eachLayer(function (layer) {
            if (layer instanceof L.PolylineDecorator && map.hasLayer(layer)) {
              map.removeLayer(layer);
            }
          });
        }
      }

      map.on("zoomend", updateTooltipsVisibility);
      map.on("baselayerchange", updateTooltipsVisibility);

      // --- 9. Basculement automatique du calque en fonction de la salle recherch√©e ---
      function switchFloor(floor) {
        // Supprime tous les tooltips personnalis√©s pour tous les calques
        salleLayer0.eachLayer(function (layer) {
          if (layer._customTooltip) {
            map.removeLayer(layer._customTooltip);
            layer._customTooltip = null;
          }
        });
        salleLayer1.eachLayer(function (layer) {
          if (layer._customTooltip) {
            map.removeLayer(layer._customTooltip);
            layer._customTooltip = null;
          }
        });
        salleLayer2.eachLayer(function (layer) {
          if (layer._customTooltip) {
            map.removeLayer(layer._customTooltip);
            layer._customTooltip = null;
          }
        });

        // Basculement du calque visible
        if (floor === "0") {
          if (!map.hasLayer(etage0)) {
            map.addLayer(etage0);
          }
          if (map.hasLayer(etage1)) {
            map.removeLayer(etage1);
          }
          if (map.hasLayer(etage2)) {
            map.removeLayer(etage2);
          }
        } else if (floor === "1") {
          if (!map.hasLayer(etage1)) {
            map.addLayer(etage1);
          }
          if (map.hasLayer(etage0)) {
            map.removeLayer(etage0);
          }
          if (map.hasLayer(etage2)) {
            map.removeLayer(etage2);
          }
        } else if (floor === "2") {
          if (!map.hasLayer(etage2)) {
            map.addLayer(etage2);
          }
          if (map.hasLayer(etage0)) {
            map.removeLayer(etage0);
          }
          if (map.hasLayer(etage1)) {
            map.removeLayer(etage1);
          }
        }
        updateTooltipsVisibility();
        updateMarkersVisibility();
      }

      var StartIcon = L.icon({
        iconUrl: "images/starticon.png",

        iconSize: [15, 15], // size of the icon
        iconAnchor: [7.5, 7.5], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -10], // point from which the popup should open relative to the iconAnchor
      });

      var EndIcon = L.icon({
        iconUrl: "images/endicon.png",

        iconSize: [15, 15], // size of the icon
        iconAnchor: [7.5, 7.5], // point of the icon which will correspond to marker's location
        popupAnchor: [0, -10], // point from which the popup should open relative to the iconAnchor
      });

      // --- 10. Variables pour la gestion des marqueurs de d√©part et d'arriv√©e ---
      var startPoint = null;
      var endPoint = null;

      // --- 11. Fonctions de surlignage (pour les recherches) ---
      function highlightFeature(layer) {
        layer.setStyle({ color: "#6AB28F", weight: 3, fillOpacity: 0.9 });
        layer.bringToFront();
      }
      // Modified resetHighlight function - REPLACE THIS SECTION
      function resetHighlight() {
        [salleLayer0, salleLayer1, salleLayer2].forEach(function (layerGroup) {
          layerGroup.eachLayer(function (layer) {
            layerGroup.resetStyle(layer);
            if (layer._customTooltip) {
              map.removeLayer(layer._customTooltip);
              layer._customTooltip = null;
            }
          });
        });
      }

      // --- 12. V√©rification et calcul de l'itin√©raire ---
      function checkAndCalculateRoute() {
        if (startPoint && endPoint) {
          var startCoords = [
            startPoint.getLatLng().lat,
            startPoint.getLatLng().lng,
          ];
          var endCoords = [endPoint.getLatLng().lat, endPoint.getLatLng().lng];
          getRouteAndPoints(startCoords, endCoords);
        }
      }

      // --- 13. Barre de recherche pour le marqueur de d√©part ---
      var searchGroup = L.featureGroup();
      salleLayer0.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });
      salleLayer1.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });
      // Apr√®s avoir ajout√© salleLayer0 et salleLayer1 √† searchGroup
      salleLayer2.eachLayer(function (layer) {
        searchGroup.addLayer(layer);
      });

      var searchControlStart = new L.Control.Search({
        layer: searchGroup,
        propertyName: "name",
        marker: false,
        collapsed: false,
        moveToLocation: function (latlng, title, map) {
          // Laisser le zoom personnalis√© se g√©rer ailleurs
        },
        position: "topleft",
        textPlaceholder: "Point de d√©part",
      });
      map.addControl(searchControlStart);
      // Ajout de l'id au container du contr√¥le start
      searchControlStart.getContainer().id = "search-control-start";
      // Lorsqu'une recherche est ouverte, ajouter un id au tooltip
      searchControlStart.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-start";
        }
      });

      searchControlStart.on("search:locationfound", function (e) {
        resetHighlight();
        if (startPoint) {
          map.removeLayer(startPoint);
          startPoint = null;
        }
        var salleFeature = e.layer;
        switchFloor(salleFeature.feature.properties.floor);
        var key =
          salleFeature.feature.properties.name ||
          salleFeature.feature.properties.salle;
        var matchingFeatures = [];
        searchGroup.eachLayer(function (layer) {
          var layerKey =
            layer.feature.properties.name || layer.feature.properties.salle;
          if (layerKey === key) {
            matchingFeatures.push(layer);
          }
        });
        if (matchingFeatures.length > 0) {
          var group = new L.featureGroup(matchingFeatures);
          map.fitBounds(group.getBounds());
          matchingFeatures.forEach(function (layer) {
            highlightFeature(layer);
          });
          var cheminFeature = null;
          var floor = salleFeature.feature.properties.floor;
          var cheminLayer =
            floor === "0"
              ? CheminEtageLayer0
              : floor === "1"
              ? CheminEtageLayer1
              : CheminEtageLayer2;
          cheminLayer.eachLayer(function (layer) {
            var layerKey =
              layer.feature.properties.name || layer.feature.properties.salle;
            if (layer.feature && layerKey === key) {
              cheminFeature = layer;
            }
          });
          if (cheminFeature) {
            var center = cheminFeature.getBounds().getCenter();
            startPoint = L.marker(center, { icon: StartIcon, floor: floor })
              .addTo(map)
              .bindPopup("Point de d√©part sur le chemin de " + key, {
                autoPan: false,
              })
              .openPopup();
          }
        }
        updateMarkersVisibility();
        checkAndCalculateRoute();
      });

      // --- 14. Barre de recherche pour le marqueur de fin ---
      var searchControlEnd = new L.Control.Search({
        layer: searchGroup,
        propertyName: "name",
        marker: false,
        collapsed: false,
        moveToLocation: function (latlng, title, map) {
          // Pas d'action ici
        },
        position: "topleft",
        textPlaceholder: "Point d'arriv√©e",
      });
      map.addControl(searchControlEnd);
      // Ajout de l'id au container du contr√¥le end
      searchControlEnd.getContainer().id = "search-control-end";
      // Lorsqu'une recherche est ouverte, ajouter un id au tooltip
      searchControlEnd.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-end";
        }
      });

      searchControlEnd.on("search:locationfound", function (e) {
        resetHighlight();
        if (endPoint) {
          map.removeLayer(endPoint);
          endPoint = null;
        }
        var salleFeature = e.layer;
        switchFloor(salleFeature.feature.properties.floor);
        var key =
          salleFeature.feature.properties.name ||
          salleFeature.feature.properties.salle;
        var matchingFeatures = [];
        searchGroup.eachLayer(function (layer) {
          var layerKey =
            layer.feature.properties.name || layer.feature.properties.salle;
          if (layerKey === key) {
            matchingFeatures.push(layer);
          }
        });
        if (matchingFeatures.length > 0) {
          var group = new L.featureGroup(matchingFeatures);
          map.fitBounds(group.getBounds());
          matchingFeatures.forEach(function (layer) {
            highlightFeature(layer);
          });
          var cheminFeature = null;
          var floor = salleFeature.feature.properties.floor;
          var cheminLayer =
            floor === "0"
              ? CheminEtageLayer0
              : floor === "1"
              ? CheminEtageLayer1
              : CheminEtageLayer2;
          cheminLayer.eachLayer(function (layer) {
            var layerKey =
              layer.feature.properties.name || layer.feature.properties.salle;
            if (layer.feature && layerKey === key) {
              cheminFeature = layer;
            }
          });
          if (cheminFeature) {
            var center = cheminFeature.getBounds().getCenter();
            endPoint = L.marker(center, { icon: EndIcon, floor: floor })
              .addTo(map)
              .bindPopup("Point de fin sur le chemin de " + key, {
                autoPan: false,
              })
              .openPopup();
          }
        }
        updateMarkersVisibility();
        checkAndCalculateRoute();
      });

      searchControlStart.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-start";
          this._tooltip.classList.add("search-tooltip-start"); // Ajoute une classe sp√©cifique
          console.log(
            "ID de la tooltip de recherche de d√©part :",
            this._tooltip.id
          );
        }
      });

      searchControlEnd.on("search:expanded", function () {
        if (this._tooltip) {
          this._tooltip.id = "search-tooltip-end";
          this._tooltip.classList.add("search-tooltip-end"); // Ajoute une classe sp√©cifique
          console.log(
            "ID de la tooltip de recherche de fin :",
            this._tooltip.id
          );
        }
      });

      function getRouteAndPoints(start, end) {
        var osrmUrl = `https://classefinder.duckdns.org/osrm/route/v1/driving/${start[1]},${start[0]};${end[1]},${end[0]}?steps=true&geometries=geojson&overview=full`;

        fetch(osrmUrl)
          .then((response) => response.json())
          .then((data) => {
            if (data.routes && data.routes.length > 0) {
              var route = data.routes[0];

              itin√©raireLayer0.clearLayers();
              itin√©raireLayer1.clearLayers();
              itin√©raireLayer2.clearLayers();

              route.legs[0].steps.forEach((step, index) => {
                var startName = step.name || "";
                var segment = {
                  type: "Feature",
                  geometry: {
                    type: "LineString",
                    coordinates: step.geometry.coordinates,
                  },
                  properties: { name: startName },
                };

                var color = "#3A5AC3";
                var itineraireLayer = itin√©raireLayer0;
                if (startName.toLowerCase().includes("1")) {
                  color = "#7898FF";
                  itineraireLayer = itin√©raireLayer1;
                } else if (startName.toLowerCase().includes("2")) {
                  color = "#FFA500";
                  itineraireLayer = itin√©raireLayer2;
                }

                var polyline = L.polyline(
                  step.geometry.coordinates.map((coord) => [
                    coord[1],
                    coord[0],
                  ]),
                  {
                    color: color,
                    weight: 10,
                  }
                );

                var arrow = L.polylineDecorator(polyline, {
                  patterns: [
                    {
                      offset: "9s",
                      repeat: "50%",
                      symbol: L.Symbol.arrowHead({
                        pixelSize: 9,
                        headAngle: 60,
                        polygon: false,
                        pathOptions: {
                          stroke: true,
                          color: "white",
                          weight: 3,
                          fill: false,
                          fillOpacity: 1,
                        },
                      }),
                    },
                    {
                      offset: "0%",
                      repeat: "50%",
                      symbol: L.Symbol.dash({
                        pixelSize: 10,
                        pathOptions: {
                          stroke: true,
                          color: "white",
                          weight: 3,
                          fill: false,
                          fillOpacity: 1,
                        },
                      }),
                    },
                  ],
                }).addTo(map);

                itineraireLayer.addLayer(polyline).addLayer(arrow);
              });

              var bounds = L.geoJSON(route.geometry).getBounds();
              map.fitBounds(bounds);
            }
          })
          .catch((error) => {
            console.error(
              "Erreur lors de la r√©cup√©ration de l'itin√©raire:",
              error
            );
          });
      }

      // --- 16. Contr√¥le des calques via le s√©lecteur ---
      var baseLayers = {
        "√âtage 1": etage1,
        "√âtage 0": etage0,
        "√âtage -1": etage2,
      };
      L.control.layers(baseLayers, null, { collapsed: false }).addTo(map);

      // Listen for layer changes and update tooltips
      map.on("baselayerchange", function (e) {
        updateTooltipsVisibility();
        updateMarkersVisibility();
      });

      map.on("baselayerchange", function (e) {
        updateTooltipsVisibility();
        updateMarkersVisibility();
      });

      map.removeLayer(etage1);

      function updateMarkersVisibility() {
        if (map.hasLayer(etage0)) {
          if (startPoint && startPoint.options.floor !== "0") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "0") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "0") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "0") {
            map.addLayer(endPoint);
          }
        } else if (map.hasLayer(etage1)) {
          if (startPoint && startPoint.options.floor !== "1") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "1") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "1") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "1") {
            map.addLayer(endPoint);
          }
        } else if (map.hasLayer(etage2)) {
          if (startPoint && startPoint.options.floor !== "2") {
            map.removeLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor !== "2") {
            map.removeLayer(endPoint);
          }
          if (startPoint && startPoint.options.floor === "2") {
            map.addLayer(startPoint);
          }
          if (endPoint && endPoint.options.floor === "2") {
            map.addLayer(endPoint);
          }
        }
      }

      // Fonction de cycle des calques au d√©marrage
      function cycleLayers() {
        // Afficher √©tage 0 imm√©diatement
        switchFloor("0");
        // Apr√®s 3 secondes, afficher √©tage 1
        setTimeout(function () {
          switchFloor("1");
          // Apr√®s 3 secondes suppl√©mentaires, afficher √©tage 2
          setTimeout(function () {
            switchFloor("2");
            setTimeout(function () {
              switchFloor("0");
            }, 1);
          }, 1);
        }, 1);
      }

      // Appeler la fonction lors du chargement du site
      cycleLayers();
    </script>
  </body>
</html>
